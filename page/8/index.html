<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fyerfyer.github.io.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">


    <meta name="description" content="fyerfyer&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="fyerfyer">
<meta property="og:url" content="https://fyerfyer.github.io.com/page/8/index.html">
<meta property="og:site_name" content="fyerfyer">
<meta property="og:description" content="fyerfyer&apos;s blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="fyerfyer">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fyerfyer.github.io.com/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>fyerfyer</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="&#x5207;&#x6362;&#x5BFC;&#x822A;&#x680F;" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">fyerfyer</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Hello! Nice to meet you!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="&#x641C;&#x7D22;" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>&#x9996;&#x9875;</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>&#x5173;&#x4E8E;</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>&#x5206;&#x7C7B;</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>&#x5F52;&#x6863;</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          &#x6587;&#x7AE0;&#x76EE;&#x5F55;
        </li>
        <li class="sidebar-nav-overview">
          &#x7AD9;&#x70B9;&#x6982;&#x89C8;
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="fyerfyer" src="/images/head.png">
  <p class="site-author-name" itemprop="name">fyerfyer</p>
  <div class="site-description" itemprop="description">fyerfyer&apos;s blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">106</span>
          <span class="site-state-item-name">&#x65E5;&#x5FD7;</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">&#x5206;&#x7C7B;</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/fyerfyer" title="GitHub &#x2192; https://github.com/fyerfyer" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/fuy60703@gmail.com" title="E-Mail &#x2192; fuy60703@gmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="&#x8FD4;&#x56DE;&#x9876;&#x90E8;">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/13/7-12-%E7%BF%BB%E8%AF%91%E5%99%A8%E5%AE%9E%E7%8E%B0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/13/7-12-%E7%BF%BB%E8%AF%91%E5%99%A8%E5%AE%9E%E7%8E%B0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">7.12.&#x7FFB;&#x8BD1;&#x5668;&#x5B9E;&#x73B0;&#x7B14;&#x8BB0;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-13 09:25:43" itemprop="dateCreated datePublished" datetime="2024-04-13T09:25:43+08:00">2024-04-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 14:54:01" itemprop="dateModified" datetime="2024-06-03T14:54:01+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="712&#x7FFB;&#x8BD1;&#x5668;&#x5B9E;&#x73B0;&#x7B14;&#x8BB0;"><span class="math inline">\(7.12.\)</span>&#x7FFB;&#x8BD1;&#x5668;&#x5B9E;&#x73B0;&#x7B14;&#x8BB0;</span></h1>
<h3><span id="1localargumentthisthattemp&#x7684;&#x5B9E;&#x73B0;">1.
<code>local,argument,this,that,temp</code>&#x7684;&#x5B9E;&#x73B0;</span></h3>
<p>&#x2003;&#x2003;&#x8FD9;&#x51E0;&#x4E2A;&#x5185;&#x5B58;&#x6BB5;&#x7684;<code>push</code>&#x5B9E;&#x73B0;&#x90FD;&#x9075;&#x5FAA;<code>*sp=*addr</code>&#x7684;&#x8FC7;&#x7A0B;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x8BE5;&#x8FC7;&#x7A0B;&#x62C6;&#x5206;&#x4E3A;&#x4E0B;&#x9762;&#x7684;&#x5B50;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<ul>
<li><code>D=*addr</code>.</li>
<li><code>*sp=D</code>.</li>
<li><code>sp++</code></li>
</ul>
<p>&#x2003;&#x2003;&#x540C;&#x65F6;&#xFF0C;&#x6839;&#x636E;&#x5148;&#x524D;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;<code>push</code>&#x64CD;&#x4F5C;&#x4E2D;&#x7684;<code>addr</code>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>baseAddr+index</code>&#x6765;&#x8BA1;&#x7B97;&#x3002;<code>index</code>&#x7684;&#x503C;&#x5F88;&#x5BB9;&#x6613;&#x83B7;&#x53D6;&#xFF0C;&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x7684;&#x64CD;&#x4F5C;&#x4E3A;<code>push local x</code>,
&#x5219;&#xFF1A; <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//get index</span><br><span class="line">@x</span><br><span class="line">D=A</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;&#x4F46;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x83B7;&#x53D6;<code>baseAddr</code>&#xFF0C;&#x56E0;&#x4E3A;&#x6B64;&#x65F6;&#x7684;D&#x5BC4;&#x5B58;&#x5668;&#x5DF2;&#x7ECF;&#x5B58;&#x50A8;&#x4E86;<code>x</code>&#x7684;&#x5E8F;&#x53F7;&#xFF0C;
&#x6211;&#x4EEC;&#x4F1A;&#x60F3;&#x901A;&#x8FC7;A&#x5BC4;&#x5B58;&#x5668;&#x83B7;&#x5F97;<code>baseAddr</code>,
&#x7136;&#x540E;&#x5C06;<code>baseAddr+index</code>&#x7684;&#x5730;&#x5740;&#x5B58;&#x5165;A&#x5BC4;&#x5B58;&#x5668;&#x4E2D;&#xFF1A; <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//get base addr</span><br><span class="line">@LCL</span><br><span class="line">A=M</span><br><span class="line">A=A+D</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;&#x987A;&#x5229;&#x5B8C;&#x6210;<code>LCL</code>&#x5185;&#x5B58;&#x6BB5;&#x7684;&#x5730;&#x5740;&#x8BFB;&#x5165;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x63A5;&#x7740;&#x7528;D&#x5BC4;&#x5B58;&#x5668;&#x8BFB;&#x5165;<code>baseAddr+index</code>&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x3002;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D=A+D</span><br></pre></td></tr></table></figure>
&#x2003;&#x2003;&#x4F46;&#x662F;&#xFF0C;&#x6B64;&#x65F6;&#x7684;<code>A</code>&#x50A8;&#x5B58;&#x7684;&#x5DF2;&#x4E0D;&#x662F;&#x539F;&#x5148;&#x7684;<code>baseAddr</code>&#x4E86;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x66F4;&#x65B0;<code>D</code>&#x7684;&#x503C;&#x662F;&#x4E0D;&#x884C;&#x7684;&#x3002;&#x8FD9;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8003;&#x8651;<strong>&#x540C;&#x65F6;&#x66F4;&#x65B0;<code>A</code>&#x4E0E;<code>D</code>&#x7684;&#x503C;</strong>&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x672A;&#x6539;&#x53D8;&#x7684;<code>A</code>&#x6210;&#x529F;&#x66F4;&#x65B0;<code>A</code>&#x4E0E;<code>D</code>:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@x</span><br><span class="line">D=A</span><br><span class="line">@LCL</span><br><span class="line">A=M //pointer</span><br><span class="line">AD=A+D</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;&#x7136;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;<code>D=*addr</code>&#xFF0C;&#x7531;&#x524D;&#x9762;&#x8BB2;&#x89E3;&#x7684;&#x6307;&#x9488;&#x7684;&#x8868;&#x793A;&#xFF0C;&#x53EA;&#x9700;&#x8865;&#x4E0A;<code>D=M</code>&#x8BED;&#x53E5;&#x5373;&#x53EF;&#x3002;</p>
<p>&#x2003;&#x2003;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x8F83;&#x4E3A;&#x7B80;&#x5355;&#x7684;<code>*sp=D</code>&#x64CD;&#x4F5C;&#x4E86;&#xFF1A; <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@SP</span><br><span class="line">A=M</span><br><span class="line">M=D</span><br><span class="line">@SP</span><br><span class="line">M=M+1</span><br></pre></td></tr></table></figure></p>
<h3><span id="2loop&#x5B9E;&#x73B0;">2.<code>Loop</code>&#x5B9E;&#x73B0;</span></h3>
<p>&#x2003;&#x2003;&#x5BF9;&#x4E8E;<code>if-goto</code>&#x8BED;&#x53E5;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x6839;&#x636E;&#x6808;&#x9876;&#x5143;&#x7D20;&#x662F;&#x5426;&#x4E3A;<code>0</code>&#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8DF3;&#x8F6C;&#x5230;&#x6240;&#x9700;&#x5206;&#x652F;&#x3002;&#x56E0;&#x4E3A;&#x5728;&#x6808;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x7528;<code>0</code>&#x8868;&#x793A;<code>false</code>&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SP</span><br><span class="line">M=M-1</span><br><span class="line">@SP</span><br><span class="line">A=M</span><br><span class="line">D=M</span><br><span class="line">@LABEL</span><br><span class="line">D;JNE</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;&#x800C;&#x5BF9;&#x4E8E;&#x65E0;&#x6761;&#x4EF6;&#x7684;<code>goto</code>&#x8BED;&#x53E5;&#xFF0C;&#x5229;&#x7528;<code>0,JMP</code>&#x5373;&#x53EF;&#x5B9E;&#x73B0;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@LABEL</span><br><span class="line">0;JMP</span><br></pre></td></tr></table></figure></p>
<h3><span id="3function&#x5B9E;&#x73B0;">3.<code>function</code>&#x5B9E;&#x73B0;</span></h3>
<p>&#x2003;&#x2003;&#x5728;<code>Hack</code>&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x4E3A;<code>function</code>&#x521B;&#x5EFA;&#x5BF9;&#x5E94;&#x6807;&#x7B7E;&#x5373;&#x53EF;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(LABEL)</span><br></pre></td></tr></table></figure></p>
<h3><span id="4call&#x5B9E;&#x73B0;">4.<code>Call</code>&#x5B9E;&#x73B0;</span></h3>
<p>&#x2003;&#x2003;&#x6211;&#x4EEC;&#x6309;&#x7167;<span class="math inline">\(8.6.\)</span>&#x8282;&#x6240;&#x8BB2;&#x9010;&#x6B65;&#x5B9E;&#x73B0;<code>call</code>&#x529F;&#x80FD;&#xFF1A;</p>
<ol type="1">
<li><p>&#x5728;&#x6808;&#x4E2D;&#x653E;&#x5165;<code>returnAddress</code>&#x7684;&#x6807;&#x7B7E;&#xFF0C;&#x8FD9;&#x6807;&#x5FD7;&#x7740;&#x6211;&#x4EEC;&#x5728;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x540E;&#x5C06;&#x8FD4;&#x56DE;&#x7684;&#x5730;&#x5740;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@return_address1</span><br></pre></td></tr></table></figure> &#x2003;&#x2003;&#x8BE5;&#x5730;&#x5740;&#x4EA6;&#x662F;&#x6808;&#x6307;&#x9488;&#x7684;&#x521D;&#x59CB;&#x4F4D;&#x7F6E;&#x6240;&#x5728;&#x4E4B;&#x5904;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">D=A</span><br><span class="line">@SP</span><br><span class="line">A=M</span><br><span class="line">M=D</span><br></pre></td></tr></table></figure></p></li>
<li><p>&#x7136;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x4F9D;&#x6B21;&#x653E;&#x5165;<code>LCL</code>, <code>ARG</code>,
<code>THIS</code>,
<code>THAT</code>&#xFF0C;&#x4EE5;&#x4FDD;&#x5B58;&#x8C03;&#x7528;&#x8005;(caller)&#x7684;&#x5185;&#x5B58;&#x6BB5;&#x3002;</p></li>
</ol>
<p>&#x2003;&#x2003;&#x5BF9;&#x4E8E;&#x6BCF;&#x4E00;&#x4E2A;&#x5185;&#x5B58;&#x6BB5;&#xFF0C;&#x6211;&#x4EEC;&#x50CF;&#x666E;&#x901A;&#x7684;<code>push</code>&#x64CD;&#x4F5C;&#x4E00;&#x6837;&#xFF0C;&#x5C06;&#x5176;&#x653E;&#x5165;&#x6808;&#x6307;&#x9488;&#x6240;&#x6307;&#x4F4D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x79FB;&#x52A8;&#x6808;&#x6307;&#x9488;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SP = memorySegment</span><br><span class="line">SP = SP + 1</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@LCL</span><br><span class="line">D=M</span><br><span class="line">@SP</span><br><span class="line">A=M</span><br><span class="line">M=D</span><br><span class="line">@SP</span><br><span class="line">M=M+1</span><br><span class="line"></span><br><span class="line">@SRG</span><br><span class="line">D=M</span><br><span class="line">@SP</span><br><span class="line">A=M</span><br><span class="line">M=D</span><br><span class="line">@SP</span><br><span class="line">M=M+1</span><br><span class="line"></span><br><span class="line">@THIS</span><br><span class="line">D=M</span><br><span class="line">@SP</span><br><span class="line">A=M</span><br><span class="line">M=D</span><br><span class="line">@SP</span><br><span class="line">M=M+1</span><br><span class="line"></span><br><span class="line">@THAT</span><br><span class="line">D=M</span><br><span class="line">@SP</span><br><span class="line">A=M</span><br><span class="line">M=D</span><br><span class="line">@SP</span><br><span class="line">M=M+1</span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x8981;&#x91CD;&#x5B9A;&#x5411;<code>ARG</code>&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x628A;&#x5B83;&#x5B9A;&#x5411;&#x81F3;<code>ARG[0]</code>&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x800C;&#x8BE5;&#x4F4D;&#x7F6E;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BA1;&#x7B97;&#x5F97;&#x51FA;&#xFF1A;</li>
</ol>
<p>&#x2003;&#x2003;&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#x4E3A;<code>call func x</code>&#xFF0C;&#x5219;&#x5728;<code>ARG</code>&#x5185;&#x5B58;&#x6BB5;&#x524D;&#x6709;4(&#x524D;&#x56DB;&#x4E2A;&#x5185;&#x5B58;&#x6BB5;)+x(<code>LCL</code>&#x9700;&#x8981;&#x7684;&#x4F4D;&#x7F6E;&#x4E2A;&#x6570;)&#xFF0C;&#x5BF9;&#x5E94;&#x4EE3;&#x7801;&#x4E3A;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@5+x</span><br><span class="line">D=A</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5C06;&#x6808;&#x6307;&#x9488;&#x79FB;&#x5230;&#x5BF9;&#x5E94;&#x4F4D;&#x7F6E;&#xFF0C;&#x5E76;&#x5C06;<code>ARG</code>&#x7684;&#x521D;&#x59CB;&#x4F4D;&#x7F6E;&#x8BBE;&#x7F6E;&#x5728;&#x8FD9;&#x91CC;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@SP</span><br><span class="line">A=M</span><br><span class="line">AD=A-D</span><br><span class="line">@ARG</span><br><span class="line">M=D</span><br></pre></td></tr></table></figure></p>
<ol start="4" type="1">
<li><p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x6B63;&#x786E;&#x8BBF;&#x95EE;<code>LCL</code>&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;<code>LCL</code>
<code>push</code>&#x5230;&#x6808;&#x6307;&#x9488;&#x6240;&#x5728;&#x4F4D;&#x7F6E;&#xFF1A; <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@SP</span><br><span class="line">D=M</span><br><span class="line">@LCL</span><br><span class="line">M=D</span><br></pre></td></tr></table></figure></p></li>
<li><p>&#x7136;&#x540E;&#xFF0C;&#x6211;&#x4EEC;<code>goto</code>&#x9700;&#x8981;&#x6267;&#x884C;&#x7684;&#x51FD;&#x6570;&#x4EE5;&#x6267;&#x884C;&#x51FD;&#x6570;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@func</span><br><span class="line">0;JMP</span><br></pre></td></tr></table></figure></p></li>
<li><p>&#x6700;&#x540E;&#x6211;&#x4EEC;&#x63D2;&#x5165;<code>returnAddress</code>&#x7684;&#x6807;&#x7B7E;&#xFF0C;&#x8FD9;&#x6837;&#x5F53;&#x51FD;&#x6570;&#x88AB;&#x6267;&#x884C;&#x5B8C;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x56DE;&#x5230;&#x6700;&#x521D;&#x8C03;&#x7528;&#x5B83;&#x7684;&#x5730;&#x65B9;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(return_address1)</span><br></pre></td></tr></table></figure></p></li>
</ol>
<h3><span id="5return&#x5B9E;&#x73B0;">5.<code>return</code>&#x5B9E;&#x73B0;</span></h3>
<p>&#x2003;&#x2003;&#x6211;&#x4EEC;&#x6309;&#x7167;<span class="math inline">\(8.6.\)</span>&#x8282;&#x6240;&#x8BB2;&#x9010;&#x6B65;&#x5B9E;&#x73B0;<code>call</code>&#x529F;&#x80FD;&#xFF1A;</p>
<ol type="1">
<li><p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;<code>frame</code>&#xFF0C;&#x5E76;&#x628A;<code>LCL</code>&#x7684;&#x503C;&#x8D4B;&#x7ED9;&#x5B83;&#x3002;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@LCL</span><br><span class="line">D=M</span><br><span class="line">@frame</span><br><span class="line">M=D</span><br></pre></td></tr></table></figure></p></li>
<li><p>&#x6211;&#x4EEC;&#x5C06;<code>return</code>&#x7684;&#x503C;&#x653E;&#x5728;&#x6808;&#x9876;&#x3002;&#x7531;&#x4E8E;&#x6709;&#x56DB;&#x4E2A;&#x5360;&#x636E;&#x4E3B;&#x5185;&#x5B58;&#x7684;&#x5185;&#x5B58;&#x6BB5;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E0A;&#x79FB;4+1=5&#x4E2A;&#xFF0C;<code>frame-5</code>&#x5373;&#x4E3A;<code>return</code>&#x7684;&#x5730;&#x5740;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@5</span><br><span class="line">A=D-A</span><br><span class="line">D=M</span><br><span class="line">@ret</span><br><span class="line">M=D</span><br></pre></td></tr></table></figure></p></li>
</ol>
<blockquote>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x6B64;&#x65F6;&#x4E0D;&#x8003;&#x8651;&#x6BCF;&#x4E2A;&#x5185;&#x5B58;&#x6BB5;&#x4E2D;&#x7684;&#x539F;&#x6709;&#x5143;&#x7D20;&#x4E86;&#x5462;&#xFF1F;&#x56E0;&#x4E3A;<strong>&#x5728;<code>return</code>&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8986;&#x76D6;&#x6240;&#x6709;&#x7684;&#x5DF2;&#x6709;&#x5143;&#x7D20;&#xFF0C;&#x8FD9;&#x8981;&#x6C42;&#x6211;&#x4EEC;&#x5C06;&#x8FD9;&#x4E9B;&#x5143;&#x7D20;&#x5F53;&#x4F5C;&#x4E0D;&#x5B58;&#x5728;</strong>&#x3002;&#x800C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x8003;&#x8651;&#x8FD9;&#x4E9B;&#x5143;&#x7D20;&#x5E76;&#x5C06;<code>ret</code>&#x4E0A;&#x79FB;&#xFF0C;<strong>&#x5728;&#x4E4B;&#x540E;&#x7684;&#x6B65;&#x9AA4;&#x4E2D;&#x5C31;&#x65E0;&#x6CD5;&#x8986;&#x76D6;&#x4E00;&#x4E9B;&#x539F;&#x6709;&#x7684;&#x65E7;&#x6570;&#x636E;&#x548C;&#x6E05;&#x7A7A;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x7684;&#x6808;&#x4E86;</strong>&#x3002;</p>
</blockquote>
<ol start="3" type="1">
<li><p>&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5C06;&#x5F85;<code>return</code>&#x7684;&#x503C;&#x590D;&#x5236;&#x5230;<code>ARG[0]</code>&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x800C;&#x8BE5;&#x503C;&#x5C31;&#x5728;&#x6808;&#x9876;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8F7B;&#x6613;&#x5730;&#x901A;&#x8FC7;&#x64CD;&#x7EB5;&#x6808;&#x6307;&#x9488;&#x8BFB;&#x53D6;&#x8BE5;&#x503C;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SP</span><br><span class="line">M=M-1</span><br><span class="line">A=M</span><br><span class="line">D=M</span><br><span class="line">@ARG</span><br><span class="line">A=M</span><br><span class="line">M=D</span><br></pre></td></tr></table></figure></p></li>
<li><p>&#x8C03;&#x7528;&#x8005;&#x9700;&#x8981;&#x80FD;&#x591F;&#x83B7;&#x53D6;&#x8BE5;&#x503C;&#xFF0C;&#x56E0;&#x6B64;&#x6808;&#x6307;&#x9488;&#x5E94;&#x4E0E;<code>ARG</code>&#x76F8;&#x90BB;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@ARG</span><br><span class="line">D=M</span><br><span class="line">@SP</span><br><span class="line">M=D+1</span><br></pre></td></tr></table></figure></p></li>
<li><p>&#x7136;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x7740;&#x624B;&#x8986;&#x76D6;&#x539F;&#x6709;&#x7684;&#x5185;&#x5B58;&#x6BB5;&#x4E86;&#x3002;&#x6211;&#x4EEC;&#x4ECE;&#x5148;&#x524D;&#x8BBE;&#x7F6E;&#x7684;<code>frame</code>&#x5730;&#x5740;&#x5F80;&#x4E0B;&#xFF0C;&#x4F9D;&#x6B21;&#x8BBE;&#x7F6E;&#x65B0;&#x7684;&#x5185;&#x5B58;&#x6BB5;&#x5730;&#x5740;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@frame</span><br><span class="line">M=M-1</span><br><span class="line">A=M</span><br><span class="line">D=M</span><br><span class="line">@THAT </span><br><span class="line">M=D</span><br><span class="line"></span><br><span class="line">@frame</span><br><span class="line">M=M-1</span><br><span class="line">A=M</span><br><span class="line">D=M</span><br><span class="line">@THIS </span><br><span class="line">M=D</span><br><span class="line"></span><br><span class="line">@frame</span><br><span class="line">M=M-1</span><br><span class="line">A=M</span><br><span class="line">D=M</span><br><span class="line">@ARG </span><br><span class="line">M=D</span><br><span class="line"></span><br><span class="line">@frame</span><br><span class="line">M=M-1</span><br><span class="line">A=M</span><br><span class="line">D=M</span><br><span class="line">@LCL </span><br><span class="line">M=D</span><br></pre></td></tr></table></figure></p></li>
<li><p>&#x6700;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x56DE;&#x5230;&#x6700;&#x521D;&#x8BBE;&#x7F6E;&#x7684;<code>ret</code>&#x4F4D;&#x7F6E;&#x3002;&#x7531;&#x4E8E;<code>ret</code>&#x5E76;&#x975E;&#x6807;&#x7B7E;&#xFF0C;&#x8981;&#x8DF3;&#x8F6C;&#x5230;&#x5176;&#x5730;&#x5740;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6307;&#x9488;&#x64CD;&#x4F5C;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@ret</span><br><span class="line">A=M</span><br><span class="line">0;JMP</span><br></pre></td></tr></table></figure></p></li>
</ol>
<h3><span id="6initial&#x5B9E;&#x73B0;">6.<code>Initial</code>&#x5B9E;&#x73B0;</span></h3>
<p>&#x2003;&#x2003;&#x5F53;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7FFB;&#x8BD1;&#x7684;VM&#x4EE3;&#x7801;&#x662F;&#x6709;&#x6548;&#x7684;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x5BF9;&#x6211;&#x4EEC;&#x7684;&#x786C;&#x4EF6;&#x7CFB;&#x7EDF;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#xFF1A;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@256</span><br><span class="line">D=A</span><br><span class="line">@SP</span><br><span class="line">M=D</span><br><span class="line"></span><br><span class="line">call Sys.init// same as other call statements before.</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/11/7-11-Hack%E5%B9%B3%E5%8F%B0%E4%B8%8A%E7%9A%84VM%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/11/7-11-Hack%E5%B9%B3%E5%8F%B0%E4%B8%8A%E7%9A%84VM%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">7.11.Hack&#x5E73;&#x53F0;&#x4E0A;&#x7684;VM&#x5B9E;&#x73B0;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-11 18:15:43" itemprop="dateCreated datePublished" datetime="2024-04-11T18:15:43+08:00">2024-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 14:51:28" itemprop="dateModified" datetime="2024-06-03T14:51:28+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="711vm-implementation-on-the-hackplatform"><span class="math inline">\(7.11.\)</span>VM Implementation on the Hack
Platform</span></h1>
<h3><span id="1program-compilation-andtranslation">1.Program compilation and
translation</span></h3>
<p><img src="/2024/04/11/7-11-Hack%E5%B9%B3%E5%8F%B0%E4%B8%8A%E7%9A%84VM%E5%AE%9E%E7%8E%B0/image.png"></p>
<ul>
<li>When we translate from Jack to VM, we lost <em>the notion of
constructors, methods</em>, because everything becomes functions.</li>
<li>When we translate from VM to assembly, we lost <em>the notion of
functions</em>, because we just have a long stream of assembly
commands.</li>
</ul>
<h3><span id="2vm-convention">2.VM convention</span></h3>
<p>&#x2003;&#x2003;In order to tranlate the VM code into assembly code, we need to
comply to certain conventions:</p>
<ol type="1">
<li><p><em>VM programming convention</em>: One file in any VM program is
expected to be named <code>Main.vm</code>; one VM function in this file
is expected to be named <code>main</code>.</p></li>
<li><p><em>VM implementation convention</em>: When the VM implementation
starts running, or is reset, it starts executing the argument-less OS
function <code>Sys.init</code>.<code>Sys.init</code> then calls
<code>Main.main</code>, and enters an infinite loop.</p></li>
<li><p><em>Hardware platform convention</em>:</p>
<ul>
<li>We request that the code you see here <strong>will be stored in the
target computer&apos;s instruction memory beginning in address
<code>0</code></strong>, for our Hack computer is programmed to start
executing the program beginning with address <code>0</code>.</li>
<li>So we first set <code>SP = 256</code>. By doing this, it will
determined that the stack should begin in this address in the whole
stream.</li>
<li>Then we <code>call Sys.init</code>.</li>
</ul></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SP = 256</span><br><span class="line">Call Sys.init</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/11/7-10-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/11/7-10-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">7.10.&#x51FD;&#x6570;&#x8FD0;&#x884C;&#x5B9E;&#x73B0;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-11 14:35:43" itemprop="dateCreated datePublished" datetime="2024-04-11T14:35:43+08:00">2024-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 14:49:14" itemprop="dateModified" datetime="2024-06-03T14:49:14+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="710function-call-and-returnimplementation"><span class="math inline">\(7.10.\)</span>Function Call and Return
Implementation</span></h1>
<h3><span id="1the-callers-view">1.The caller&apos;s view</span></h3>
<p>&#x2003;&#x2003;In the calling function&apos;s view:</p>
<ul>
<li>Before calling another function, I must <strong>push as many
arguments as the function expects to get</strong>;</li>
<li>Next, I invoke the function using
<code>call functionName nArgs</code>;</li>
<li>After the called function returns, the argument values that I pushed
before the call have disappeared from the stack, and <strong>a return
value (that always exists) appears at the top of the
stack</strong>;</li>
<li>After the called function returns, <strong>all my memory segments
are exactly the same as they were before the call</strong> (except that
temp is undefined and some values of my static segment may have
changed).</li>
</ul>
<h3><span id="2the-callees-view">2.The callee&apos;s view</span></h3>
<p>&#x2003;&#x2003;In the called function&apos;s view:</p>
<ul>
<li>Before I start executing, <strong>my<code>argument</code> segment
has been initialized with the argument values passed by the
caller</strong>.</li>
<li>My <strong><code>local</code> variables segment has been allocated
and initialized to zeros</strong>.</li>
<li>My <code>static</code> segment has been set to <strong>the
<code>static</code> segment of the VM file to which I belong</strong>
(memory segments <code>this</code>, <code>that</code>,
<code>pointer</code>, and <code>temp</code> are undefined upon
entry).</li>
<li>My working stack is empty.</li>
<li>Before returning, I must <strong>push a value onto the
stack</strong>.</li>
</ul>
<h3><span id="3handling-call">3.Handling <code>call</code></span></h3>
<p>&#x2003;&#x2003;We can implement the VM code by these steps:</p>
<p><img src="/2024/04/11/7-10-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E5%AE%9E%E7%8E%B0/image.png"></p>
<p>&#x2003;&#x2003;In terms of <code>call</code>, we do these steps:</p>
<ol type="1">
<li><p>Push a label onto the stack, and use the same label when we are
going to return after the called function terminates.
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push returnAddress</span><br></pre></td></tr></table></figure></p></li>
<li><p>Push some label that we generate to <strong>save the memory
segment of the caller</strong>: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">push LCL</span><br><span class="line">push ARG</span><br><span class="line">push THIS</span><br><span class="line">push THAT</span><br></pre></td></tr></table></figure></p></li>
<li><p>The <code>argument</code> should <strong>be repositioned for the
called function</strong>, and we should reposition it at the beginning
of the <code>ARG</code> segment:</p>
<ul>
<li>We can calculate the address, because we know how many values we
pushed. Say we push 5 values the we do : <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARG = SP - 5</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>Push the <code>local</code> segment to insure that the function
can visit its local variables correctly : <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LCL = SP</span><br></pre></td></tr></table></figure></p></li>
<li><p>We execute the called function by simply writing the command
<code>goto nameOfFunction</code>: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goto functionName</span><br></pre></td></tr></table></figure></p></li>
<li><p>We insert the <code>returnAddress</code> label, so that when the
function has been executed, we can get back to the place we invoke it :
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(returnAddress) //Declares a label for the return-address</span><br></pre></td></tr></table></figure></p></li>
</ol>
<p><img src="/2024/04/11/7-10-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E5%AE%9E%E7%8E%B0/image-1.png"></p>
<h3><span id="4handling-function">4.Handling <code>function</code></span></h3>
<p>&#x2003;&#x2003;The big picture of handling <code>function</code> is that:</p>
<ul>
<li>The first thing translator does is <strong>it takes the function
name and generates a label</strong>, and the label will serve as
<strong>the entry point to the translated assembly code of the
function</strong>.</li>
<li>We simply write some assembly code that <strong>handles the setting
up of the function&apos;s execution</strong>.</li>
</ul>
<ol type="1">
<li>We take the function name and generate its label:</li>
<li>Since we know how many local variables we have to create, we do
<code>push 0</code> <code>nVars</code> times. <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(functionName)</span><br><span class="line">	//repeat nVars times</span><br><span class="line">	push 0</span><br></pre></td></tr></table></figure></li>
</ol>
<h3><span id="4handling-return">4.Handling <code>return</code></span></h3>
<p>&#x2003;&#x2003;After setting up, the function can start doing its thing. We need
to generate assembly code that <strong>moves the return value to the
caller, reinstates the caller&apos;s state, and finally <code>goto</code> the
return address</strong>.</p>
<ol type="1">
<li>Create some temporary variable (called <code>endFrame</code>) and
assign the value of <code>LCL</code> to it: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">endFrame = LCL</span><br></pre></td></tr></table></figure></li>
</ol>
<p>&#x2003;&#x2003;If you look at the stack diagram, you will see that
<code>endFrame</code> indeed <strong>points at the end of the frame in
the host RAM</strong>.</p>
<p><img src="/2024/04/11/7-10-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E5%AE%9E%E7%8E%B0/image-2.png"></p>
<ol start="2" type="1">
<li><p>Since we should put the return value at the top of the stack, say
we have 5 values, the <code>endFrame - 5</code> will be the exact return
address.</p>
<ul>
<li>We need to use <code>*</code> to look inside and get the address.
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retaddr = *(endFrame - 5)</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>Reposition the return value for the caller.</p>
<ul>
<li>The value should be copied to <code>argument 0</code>, and we
already have a pointer <code>ARG</code> located in the position</li>
<li><code>pop</code> is going to retrieve the return value off the
stack. We take this value and put it in <code>ARG</code>.
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*ARG = pop()</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>The caller expects to see a return value and continue to do its
work, so the stack pointer should <strong>be just after
<code>ARG</code></strong>.<br>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SP = ARG + 1</span><br></pre></td></tr></table></figure></p></li>
<li><p>Then we can begin to recover the various segments that we saved
on the stack before. <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">THAT = *(endFrame - 1)</span><br><span class="line">THIS = *(endFrame - 2)</span><br><span class="line">ARG = *(endFrame - 3)</span><br><span class="line">LCL = *(endFrame - 4)</span><br></pre></td></tr></table></figure></p></li>
<li><p>Finally we can jump to the return address we copied before:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goto retAddr</span><br></pre></td></tr></table></figure></p></li>
</ol>
<p><img src="/2024/04/11/7-10-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E5%AE%9E%E7%8E%B0/image-3.png"></p>
<ul>
<li>Every thing below <code>SP</code> is recycled. <strong>The next push
is going to override the memory location where <code>SP</code>
shows</strong>.</li>
<li>The caller will see the return value at the top of its working
stack.</li>
<li>The stack pointer will point at the next world in the memory.</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/" class="post-title-link" itemprop="url">7.9.&#x51FD;&#x6570;&#x8FD0;&#x884C;&#x6A21;&#x62DF;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-11 10:32:46" itemprop="dateCreated datePublished" datetime="2024-04-11T10:32:46+08:00">2024-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 14:44:19" itemprop="dateModified" datetime="2024-06-03T14:44:19+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="79run-time-simulation"><span class="math inline">\(7.9.\)</span>Run-time Simulation</span></h1>
<h3><span id="1run-time-example">1.Run-time example</span></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">int main() {</span><br><span class="line">	return factorial(3);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">int factorial(int n) {</span><br><span class="line">	if (n == 1) return 1;</span><br><span class="line">	else return n * factorial(n - 1);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ul>
<li><p>When compiling the <code>main</code> part, we:</p>
<ul>
<li><code>push 3</code></li>
<li><code>call factorial</code></li>
<li><code>return</code></li>
</ul></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function main</span><br><span class="line">	push 3</span><br><span class="line">	call factorial</span><br><span class="line">	return</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Then we start to compile the function:</p>
<ul>
<li>We declare the function.</li>
<li>We evaluate the condition <code>n==1</code></li>
<li>If the conitional statement returns false, we <code>push n</code>,
and compute <code>factorial(n - 1)</code></li>
</ul></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function factorial(n) </span><br><span class="line">	push n</span><br><span class="line">	push 1</span><br><span class="line">	eq </span><br><span class="line">	if-goto BASECASE</span><br><span class="line">	</span><br><span class="line">	push n</span><br><span class="line">	push n</span><br><span class="line">	pusn 1</span><br><span class="line">	sub</span><br><span class="line">	call factorial</span><br><span class="line">	call mult</span><br><span class="line">	return</span><br><span class="line"></span><br><span class="line">label BASECASE</span><br><span class="line">	push 1</span><br><span class="line">	return</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;The pseudo VM code can be translated into these VM codes:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function main 0</span><br><span class="line">	push constant 3</span><br><span class="line">	call factorial 1</span><br><span class="line">	return</span><br><span class="line"></span><br><span class="line">function factorial 0</span><br><span class="line">	push argument 0</span><br><span class="line">	push constant 1</span><br><span class="line">	eq</span><br><span class="line">	if-goto BASECASE</span><br><span class="line"></span><br><span class="line">	push argument 0</span><br><span class="line">	push argument 0</span><br><span class="line">	push constant 1</span><br><span class="line">	sub</span><br><span class="line">	call factorial 1</span><br><span class="line">	call mult 2</span><br><span class="line">	return </span><br><span class="line"></span><br><span class="line">label BASECASE</span><br><span class="line">	push constant 1</span><br><span class="line">	return</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;Then what happen during the runtime?</p>
<ol type="1">
<li><code>main</code> starts running, and informs that it has 0 local
variable.</li>
<li><code>main</code> pushes, so it starts with an empty stack.</li>
<li><code>push constant 3</code>, then we get a 3 on the stack.</li>
</ol>
<p><img src="/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/image.png"></p>
<ol start="4" type="1">
<li><code>call factorial 1</code>, the 1 informs that 1 argument was
pushed onto the stack. So we can <strong>refer to the topmost value in
the stack as argument 0</strong>.</li>
</ol>
<p><img src="/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/image-1.png"></p>
<h3><span id="2callee-process">2.Callee process</span></h3>
<p>&#x2003;&#x2003;Then we begin to deal with the <code>call</code> command.</p>
<ol type="1">
<li>We first <strong>save the frame of <code>main</code> onto the
stack</strong>. Then we jump to execute <code>factorial</code>.</li>
</ol>
<p><img src="/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/image-2.png"></p>
<ul>
<li>The blue dot shows the <em>return address</em> in the given code.
And this is exactly where we want to return to after
<code>factorial</code> finishes.</li>
</ul>
<ol start="2" type="1">
<li>The <code>eq</code> consumes <code>argument 0</code> and
<code>constant 1</code>, so <strong>the overall effect of the first 4
commands on the stack is <code>nil</code></strong>.</li>
<li>We <code>push argument 0</code>, <code>push argument 0</code>,
<code>push constant 1</code>, <code>sub</code>, so we are going to get 3
and 2 on the stack.</li>
</ol>
<p><img src="/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/image-3.png"></p>
<ol start="4" type="1">
<li><code>call factorial 1</code>, we <strong>inform the implementation
that 1 argument has been pushed onto the stack</strong>, we can refer to
it as <code>argument 0</code>.</li>
<li>We want to issue a <code>call</code> command, so the implementation
is going to <strong>save the frame of the current function</strong>, and
the return address is the green dot, we save it, too.</li>
</ol>
<p><img src="/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/image-4.png"></p>
<ol start="6" type="1">
<li>After several calls, we turn to <code>f(1)</code>, and the global
stack now looks like this:</li>
</ol>
<p><img src="/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/image-5.png"></p>
<ol start="7" type="1">
<li>This time 1 equals 1, we jump to <code>BASECASE</code>,
<code>push constant 1</code> and do a <code>return</code>.</li>
</ol>
<p>&#x2003;&#x2003;When the inplementation encounters the <code>return</code> command,
it:</p>
<ol type="1">
<li>Gets the return address off the stack.</li>
<li>Copy the return value. In this case, it&apos;s <code>argument 0</code>,
so we copy 1 on <code>arg0</code>.</li>
<li>After <code>return</code>, we can recycle the current frame, which
is no more relevant.</li>
</ol>
<p><img src="/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/image-6.png"></p>
<p>&#x2003;&#x2003;And we do this step again and again:</p>
<p><img src="/2024/04/11/7-9-%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F/image-7.png"></p>
<p>&#x2003;&#x2003;During the process, the caller is completely oblivious of all the
drama, it takes part behind the scene.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/11/7-8-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%9E%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/11/7-8-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%9E%BB/" class="post-title-link" itemprop="url">7.8.&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x524D;&#x77BB;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-11 08:22:16" itemprop="dateCreated datePublished" datetime="2024-04-11T08:22:16+08:00">2024-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 14:37:35" itemprop="dateModified" datetime="2024-06-03T14:37:35+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="78function-impletation-preview"><span class="math inline">\(7.8.\)</span>Function Impletation Preview</span></h1>
<h3><span id="1program-execution">1.Program execution</span></h3>
<ul>
<li><p>When a function enters its execution, we need to create a
<em>state</em> for this function.</p>
<ul>
<li>Give it an <em>empty working stack</em>, its <em>memory
segment</em>.</li>
</ul></li>
<li><p>The working stack and some of the segments should be:</p>
<ul>
<li>Created <strong>when the function starts running</strong>.</li>
<li><strong>Maintained as long as the function is
executing</strong>.</li>
<li><strong>Recycled</strong> when the function retums.</li>
</ul></li>
<li><p>When we call a function, we will have two states: the state of
<em>caller</em> and the state of <em>callee</em>. Once the callee starts
running, <strong>the state of the caller has to be saved
somewhere</strong>. And when the callee terminates, we can
<strong>reinstate the caller state and continue its
execution</strong>.</p></li>
</ul>
<p><img src="/2024/04/11/7-8-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%9E%BB/image.png"></p>
<h3><span id="2function-call-and-return">2.Function call and return</span></h3>
<p>&#x2003;&#x2003;However, a <em>calling chain</em> may be several functions deep,
and how can we maintain all the states of these functions?</p>
<p>&#x2003;&#x2003;To deal with this, we can use the <em>FILO</em> (first in last out)
pattern. The only function to be return is the function which is
currently running, and which is also <strong>the end of the calling
chain</strong>. Once this function returns, the calling chain shortens,
so on and so forth.</p>
<p>&#x2003;&#x2003;This pattern is similiar to <em>stack</em>, this implies that we
may use a stack in order to save and retrieve all these function
states.</p>
<p>&#x2003;&#x2003;Take this simple function as example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mult(17, 212)</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;In the view of the caller, the effect of the procedure is that
<strong>the function&apos;s arguements has been replaced with the function
value</strong>:</p>
<p><img src="/2024/04/11/7-8-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%9E%BB/image-1.png"></p>
<p>&#x2003;And the details are as follows:</p>
<ul>
<li><p>We push some values in the stack, and nothing happens. And then
we <code>call foo nArgs</code>.</p></li>
<li><p>By the information <code>nArgs</code>, we know where to
<strong>set <code>arg</code> pointer</strong>.</p>
<ul>
<li>From now on, we know what&apos;s above the <code>arg</code> is
<strong>the working stack of the caller</strong>, and what&apos;s below the
<code>arg</code> are <strong>the arguments to be use by
callee</strong>.</li>
</ul></li>
<li><p>Before we jump to the called function, we have to save the state
of the caller:</p>
<ul>
<li>The working stack is safe, it is already on the stack, so we can
leave it alone.</li>
<li>We have to save the <em>segment</em> and the <em>return
address</em>. Taken together, we call these thing <em>frame</em>.</li>
<li>The VM implementation simply <strong>push these memory segments into
stack</strong>. In this way we save the frame, and will be able to
return to them later on.</li>
</ul></li>
</ul>
<p><img src="/2024/04/11/7-8-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%9E%BB/image-2.png"></p>
<ul>
<li>Jump to <strong>execute foo</strong>.</li>
</ul>
<p>&#x2003;&#x2003;After the called function is entered, it:</p>
<ul>
<li><p>Create a <em>local segment</em>.</p></li>
<li><p>Having known that we need n variables, we need to
<strong>initialize them to 0</strong></p>
<ul>
<li>From now on, we can refer to these values as <code>local 0</code>,
<code>local 1</code> and so on.</li>
</ul></li>
</ul>
<p><img src="/2024/04/11/7-8-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%9E%BB/image-3.png"></p>
<p>&#x2003;&#x2003;Assume that the called function is running and doing its things, in
this process, it:</p>
<ul>
<li>Grow its working stack, and it now has a working stack of its
own.</li>
</ul>
<p><img src="/2024/04/11/7-8-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%9E%BB/image-4.png"></p>
<ul>
<li><p>When it is goint to <code>return</code> at some point, we push
the return value <strong>at the bottom of the stack</strong>.</p></li>
<li><p>We pop the topmost value, and <strong>copy it onto
<code>argument 0</code></strong> to replace the pushed arguments with
return value.</p></li>
<li><p>We <strong>restore the segment pointers of the callers</strong>,
take the saved <em>memory segments</em> to the <em>current
segments</em>.</p></li>
<li><p>Then we <strong>clear the stack of the called function</strong>,
and <strong>set the stack pointer for the caller</strong>.</p>
<ul>
<li>The stack pointer should be located after
<code>argument 0</code>.</li>
</ul></li>
<li><p>Finally, we <strong>jump to the return address</strong> in the
caller, and continue executing the caller&apos;s code.</p></li>
</ul>
<h3><span id="3global-stack">3.Global stack</span></h3>
<p>&#x2003;&#x2003;Our previous discussion is only about the caller and callee, but
there are many other pairs of callers and callees in the calling chain,
and we have to maintain their states, too.</p>
<p>&#x2003;&#x2003;As a result, we get a very large stack called <em>global stack</em>
containing the information of the entire program.</p>
<ul>
<li><p>We refer to some subset of the global stack <em>block</em>. It&apos;s
the world of the currently running function, and it contains:</p>
<ul>
<li><em>argument segment</em>. These are the function&apos;s arguments.</li>
<li><em>saved information that belongs to caller</em>.</li>
<li><em>local segment</em></li>
<li><em>working stack of its own</em></li>
</ul></li>
</ul>
<p><img src="/2024/04/11/7-8-%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%9E%BB/image-5.png"></p>
<ul>
<li>The global stack contains many more such blocks.</li>
</ul>
<p>&#x2003;&#x2003;And there are some more observations we can make:</p>
<ul>
<li>We only have to save <code>local</code>, <code>argument</code>,
<code>this</code> and <code>that</code> segments, for the other four
parts don&apos;t belong to the world of the function.</li>
<li>We use the stack not only when executing the program, but also
executing all the behind-scene apparatus that is required to service the
program. Everything is saved on the same stack.</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/10/7-7-%E5%87%BD%E6%95%B0%E6%8A%BD%E8%B1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/10/7-7-%E5%87%BD%E6%95%B0%E6%8A%BD%E8%B1%A1/" class="post-title-link" itemprop="url">7.7.&#x51FD;&#x6570;&#x62BD;&#x8C61;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-10 20:12:16" itemprop="dateCreated datePublished" datetime="2024-04-10T20:12:16+08:00">2024-04-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 14:32:41" itemprop="dateModified" datetime="2024-06-03T14:32:41+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="77function-abstraction"><span class="math inline">\(7.7.\)</span>Function: Abstraction</span></h1>
<h3><span id="1function-in-vm-language">1.Function in VM language</span></h3>
<ul>
<li><p>The VM language features:</p>
<ul>
<li><em>primitive operation</em>(fixed): <code>add</code>,
<code>sub</code></li>
<li><em>abstract operation</em>(extensible): <code>mutiple</code></li>
</ul></li>
</ul>
<p>&#x2003;&#x2003;When we want to call a function, we:</p>
<ul>
<li>push the required argument onto the stack.</li>
<li>call the function. Then <strong>the result of function will replace
the argument you push earlier</strong>.</li>
</ul>
<p>&#x2003;&#x2003;Take this simple funtion call <code>sqrt(x-17+x*5)</code> as
example, it can be translated into: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">push x</span><br><span class="line">push 17</span><br><span class="line">sub</span><br><span class="line">push x </span><br><span class="line">push 5</span><br><span class="line">call Math.multiply</span><br><span class="line">add </span><br><span class="line">call Math.sqrt</span><br></pre></td></tr></table></figure></p>
<h3><span id="2function-definition">2.Function definition</span></h3>
<p>&#x2003;&#x2003;Take the previous function as example: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// returns x&quot;y</span><br><span class="line">int mult(int x, int y) {</span><br><span class="line">	int sum = 0;</span><br><span class="line">	int n = 1;</span><br><span class="line">	while !(n&gt;y) {</span><br><span class="line">		sum += x;</span><br><span class="line">		x ++;</span><br><span class="line">	}</span><br><span class="line">	return sum;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;As is discussed before, it&apos;s pseudo VM code is as below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function mult(x,y)</span><br><span class="line">	push 0</span><br><span class="line">	pop sum</span><br><span class="line">	push 1</span><br><span class="line">	pop n</span><br><span class="line">label LOOP</span><br><span class="line">	push n</span><br><span class="line">	push y</span><br><span class="line">	gt</span><br><span class="line">	if-goto ENDLOOP</span><br><span class="line">	push sum</span><br><span class="line">	push x</span><br><span class="line">	add</span><br><span class="line">	pop sum</span><br><span class="line">	push n</span><br><span class="line">	push 1</span><br><span class="line">	add</span><br><span class="line">	pop n</span><br><span class="line">	goto LOOP</span><br><span class="line">label ENDLOOP</span><br><span class="line">	push sum</span><br><span class="line">	return</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;In fact, it can be translated into this VM code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function mult 2</span><br><span class="line">	push constant 0 //sum = 0</span><br><span class="line">	pop local 0</span><br><span class="line">	push constant 1 //n = 1</span><br><span class="line">	pop local 1</span><br><span class="line">label LOOP</span><br><span class="line">	push local 1 //if clause</span><br><span class="line">	push argument 1</span><br><span class="line">	gt</span><br><span class="line">	if-goto ENDLOOP</span><br><span class="line">	push local 0 // sum += x</span><br><span class="line">	push argument 0</span><br><span class="line">	add</span><br><span class="line">	pop local 0</span><br><span class="line">	pop local 1 // n ++</span><br><span class="line">	push constant 1</span><br><span class="line">	add</span><br><span class="line">	pop local 1</span><br><span class="line">	goto LOOP</span><br><span class="line">label ENDLOOP</span><br><span class="line">	push local 0 // return sum</span><br><span class="line">	return</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;Let&apos;s discuss the implementation in detail:</p>
<ol type="1">
<li><p><em>Function declaration</em>:</p>
<ul>
<li><code>Function</code>: function declaration.</li>
<li><code>mult</code>: the name of the function.</li>
<li><code>2</code>: use 2 <em>local variables</em> in the function.</li>
</ul></li>
<li><p><em>Function body</em>:</p>
<ul>
<li>branching.</li>
<li>the variable declared within the body should be stored in
<code>local</code>.</li>
<li>the assignment of variables can be done through
<code>push constant</code> and <code>pop local</code>.</li>
</ul></li>
<li><p><em>Return value</em></p>
<ul>
<li><code>push</code> the to-return value in the stack.</li>
<li><code>return</code> statement at the end of program.</li>
</ul></li>
</ol>
<h3><span id="3function-execution">3.Function execution</span></h3>
<p>&#x2003;&#x2003;We can execute a function in a <code>Main</code> function:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function main 0</span><br><span class="line">	push constant 3</span><br><span class="line">	push constant 5</span><br><span class="line">	push constant 8</span><br><span class="line">	call mult 2</span><br><span class="line">	add </span><br><span class="line">	return </span><br></pre></td></tr></table></figure></p>
<ul>
<li>the <code>2</code> next to <code>mult</code> indicates that
<strong>the funtion takes in 2 arguments</strong>.</li>
<li>the whole process can be described through these diagrams:</li>
</ul>
<p><img src="/2024/04/10/7-7-%E5%87%BD%E6%95%B0%E6%8A%BD%E8%B1%A1/image.png"></p>
<p><img src="/2024/04/10/7-7-%E5%87%BD%E6%95%B0%E6%8A%BD%E8%B1%A1/image-1.png"></p>
<p><img src="/2024/04/10/7-7-%E5%87%BD%E6%95%B0%E6%8A%BD%E8%B1%A1/image-2.png"></p>
<p>&#x2003;&#x2003;for each function <code>call</code> during run-time, the
implementation of the <code>call</code> command should :</p>
<ul>
<li><p><strong>Pass parameters</strong> from the calling function to the
called function;</p></li>
<li><p><strong>Determine the return address</strong> within the caller&apos;s
code;</p></li>
<li><p><strong>Save the caller&apos;s return address, stack and memory
segments</strong>;</p>
<ul>
<li>so that when we return to the <code>main</code>, we will be able to
<strong>recreate the private world of <code>main</code></strong>.</li>
</ul></li>
<li><p>Jump to <strong>execute the called fiunction</strong>:</p></li>
</ul>
<p>&#x2003;&#x2003;And for each function <code>return</code> during run-time, the
impletation has to:</p>
<ul>
<li><p>Return to the caller <em>the value computed by the called
function</em>;</p>
<ul>
<li>The implementation knows that the topmost value on the stack must be
the return value, so it returns the value.</li>
</ul></li>
<li><p><strong>Recycle the memory resources</strong> used by the called
funetion;</p></li>
<li><p><strong>Reinstate the caller&apos;s stack and memory
segments</strong>;</p></li>
<li><p>Jump to the <strong>return address in the caller&apos;s
code</strong>.</p></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/10/7-7-%E5%88%86%E6%94%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/10/7-7-%E5%88%86%E6%94%AF/" class="post-title-link" itemprop="url">7.6.&#x5206;&#x652F;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-10 16:44:10" itemprop="dateCreated datePublished" datetime="2024-04-10T16:44:10+08:00">2024-04-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 14:28:40" itemprop="dateModified" datetime="2024-06-03T14:28:40+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="76branching"><span class="math inline">\(7.6.\)</span>Branching</span></h1>
<h3><span id="1branching-implementation">1.Branching implementation</span></h3>
<p>&#x2003;&#x2003;Take the following program as example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//return x * y</span><br><span class="line">int mult (int x, int y) {</span><br><span class="line">	int sum = 0;</span><br><span class="line">	int n = 1;</span><br><span class="line"></span><br><span class="line">	while !(n&gt;y) {</span><br><span class="line">		sum += x;</span><br><span class="line">		n++;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	return sum;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;This program can be translated into pseudo VM code as below:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function mult(x,y)</span><br><span class="line">	push 0</span><br><span class="line">	pop sum</span><br><span class="line">	push 1</span><br><span class="line">	pop n</span><br><span class="line">label LOOP</span><br><span class="line">	push n</span><br><span class="line">	push y</span><br><span class="line">	gt</span><br><span class="line">	if-goto ENDLOOP</span><br><span class="line">	push sum</span><br><span class="line">	push x</span><br><span class="line">	add</span><br><span class="line">	pop sum</span><br><span class="line">	push n</span><br><span class="line">	push 1</span><br><span class="line">	add</span><br><span class="line">	pop n</span><br><span class="line">	goto LOOP</span><br><span class="line">label ENDLOOP</span><br><span class="line">	push sum</span><br><span class="line">	return</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;Notice that we have three new symbols: <code>label</code>,
<code>if-goto</code>, <code>goto</code>:</p>
<ul>
<li><code>label LABEL</code> declare the label.</li>
<li><code>if-goto LABEL</code>: if the statement is true, then jump to
<code>LABEL</code>.</li>
<li><code>goto LABEL</code>: jump to <code>LABEL</code> with no
condition.</li>
</ul>
<p>&#x2003;&#x2003;With these three statement, we can translate the branching
expression into VM code.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">7.5.&#x5185;&#x5B58;&#x6BB5;&#x7684;&#x5B9E;&#x73B0;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-09 10:32:16" itemprop="dateCreated datePublished" datetime="2024-04-09T10:32:16+08:00">2024-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 08:15:56" itemprop="dateModified" datetime="2024-06-03T08:15:56+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="75memory-segment-implementation"><span class="math inline">\(7.5.\)</span>Memory Segment implementation</span></h1>
<h3><span id="1local-implementation">1.<code>local</code> implementation</span></h3>
<p>&#x2003;&#x2003;The <code>local</code> segment can be placed <strong>anywhere we
want in the host RAM</strong>, for we just need to <strong>remember the
base address of the block</strong>.</p>
<ul>
<li>We place the <strong>base address of the <code>local</code>
segment</strong> in a pointer called <em>LCL</em>.</li>
<li><em>LCL</em> will refer to <code>RAM 1</code>.</li>
</ul>
<p><img src="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/image.png"></p>
<p><img src="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/image-1.png"></p>
<p>&#x2003;&#x2003;Then we can <code>push</code> or <code>pop</code> a value easily.
Say we want to accomplish <code>pop local 2</code>:</p>
<p><img src="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/image-2.png"></p>
<p>&#x2003;&#x2003;We can do this by putting the stack-top value into
<code>RAM[1015]</code>.</p>
<p><img src="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/image-3.png"></p>
<ul>
<li>How do we know which <code>RAM</code> to add to? We get it by
<code>base addr + index</code></li>
</ul>
<p>&#x2003;&#x2003;This process can be translated into this VM code: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//get the place to be added</span><br><span class="line">addr = addr + index</span><br><span class="line">//get the value, and put it into correct place</span><br><span class="line">sp--</span><br><span class="line">*addr = *sp</span><br><span class="line">// D = *sp, *addr = D</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;Notice that 5 is still in <code>RAM[257]</code>, it hasn&apos;t been
removed. It&apos;s common to have these wasted data in the stack, and it&apos;s
not big deal, for <strong>the pointer indicates exactly which part of
the stack are in play, not the data</strong>.</p>
<h3><span id="2argumentthisthatimplementation">2.<code>argument,this,that</code>
implementation</span></h3>
<ul>
<li><p>When translating the high-level code of some method into VM
code:</p>
<ul>
<li>Maps the method&apos;s local and argument variables onto the
<code>local</code> and <code>argument</code> segments</li>
<li>Maps the object fields and the array entries that the method is
currently processing onto the <code>this</code> and <code>that</code>
segments</li>
</ul></li>
</ul>
<p>&#x2003;&#x2003;The process of <code>argument</code>, <code>this</code> and
<code>that</code> is nearly the same as <code>local</code>:</p>
<p><img src="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/image-4.png"></p>
<p>&#x2003;&#x2003;The process can be translated into this VM code: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//push</span><br><span class="line">addr = segmentPointer + index</span><br><span class="line">*sp = *addr</span><br><span class="line">sp++</span><br><span class="line"></span><br><span class="line">//pop</span><br><span class="line">addr = segmentPointer + index</span><br><span class="line">sp--</span><br><span class="line">*addr = *sp</span><br></pre></td></tr></table></figure></p>
<h3><span id="3constant">3.<code>Constant</code></span></h3>
<ul>
<li><p>When the compiler translates the high-level code of some method
into VM,</p>
<ul>
<li>it translates high-level operations involving constant into VM
operations involving the constant segment.</li>
</ul></li>
<li><p>When we implement <code>constant</code>, we simply <strong>supply
the specified constant</strong>.</p></li>
<li><p>Since we won&apos;t store things where a <code>constant</code>
resides, there&apos;s no <code>pop</code> in <code>constant</code>.</p></li>
<li><p>The <code>constant</code> segment is a <strong>truly virtual
segment</strong>. So whenever we see a <code>push constant i</code>
command, we simply supply the specified constant
<code>i</code>.</p></li>
</ul>
<p><img src="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/image-5.png"></p>
<h3><span id="4static">4.<code>Static</code></span></h3>
<ul>
<li><p>When translating the high-level code of some method into VM code,
the compiler:</p>
<ul>
<li>Maps the static variables that the method sees onto the
<code>static</code> segment.</li>
</ul></li>
<li><p>The <code>static</code> variables should <strong>be seen by all
the methods in a program</strong>. &#x2003;&#x2003;To complement this, we store the
variables in a <em>&quot;global space&quot;</em>:</p></li>
<li><p>Have the VM translator translate each VM reference
<code>static i</code>(in file <code>Foo.vm</code>)into an <em>assembly
reference</em> <code>Foo.i</code>.</p>
<ul>
<li><code>Foo</code> is the name of the file, and <code>i</code> is the
index of VM command.</li>
</ul></li>
<li><p>Following assembly, the Hack assembler will map these references
onto <code>RAM[16]</code>,<code>RAM[17]</code>,<code>RAM[18]</code>,
...</p></li>
</ul>
<p>&#x2003;&#x2003;For example, the statement <code>pop static 5</code> can be
translated into: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Foo.5</span><br><span class="line">M = D</span><br><span class="line">//the register stores this data</span><br><span class="line"></span><br><span class="line">@Foo.2</span><br><span class="line">M = D</span><br></pre></td></tr></table></figure> * The entries of <code>static</code>
segment will end up being mapped onto <code>RAM[16]</code>,
<code>RAM[17]</code>, ... , in the order <strong>in which they appear in
the program</strong> (not their names!!!).</p>
<figure>
<img src="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/image-6.png" alt="Alt text">
<figcaption aria-hidden="true">Alt text</figcaption>
</figure>
<blockquote>
<p>Static variables are stored <strong>in a section of memory called the
static data segment</strong>, which is allocated when the program is
loaded and has fixed memory addresses. When we want to retrieve the
value of a static variable, we need to read the value stored <strong>at
the memory location</strong> where the static variable is stored, rather
than directly accessing the value of the static variable itself. This is
why we need to use <code>D=M</code> instead of <code>D=A</code> to get a
<code>static</code> value.</p>
</blockquote>
<h3><span id="5temp">5.<code>Temp</code></span></h3>
<p>&#x2003;&#x2003;When the compiler translates the Jack program into VM code, it
sometimes has to use temporary variables.</p>
<ul>
<li>We let the 8 place segment called <code>temp</code> to contain and
serve these variables when needed.</li>
<li><code>temp</code> is going to be a <strong>fixed 8-place memory
segment</strong>.</li>
<li>The variables will be mapped on <code>RAM</code> locations 5 to
12.</li>
</ul>
<p><img src="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/image-7.png"></p>
<h3><span id="6pointer">6.Pointer</span></h3>
<ul>
<li><p>When translating a high-level method code into VM code,the
compiler:</p>
<ul>
<li>Has to remember the base addresses of <code>this</code>, which
represents <em>the current object</em>, and <code>that</code>, which
represents <em>the current array of method be processing</em>.</li>
<li>Generates code that <strong>keeps track of the base addresses of the
this and that segments</strong> using the pointer segment.</li>
</ul></li>
<li><p><code>pointer</code> is a fixed memory segment. It has only two
entries, <code>0</code> and <code>1</code>.</p>
<ul>
<li>So we can only <code>push</code> and <code>pop</code> <code>0</code>
and <code>1</code></li>
</ul></li>
<li><p>Accessing <code>pointer 0</code> should result in
<strong>accessing <code>THIS</code></strong>.</p></li>
<li><p>Accessing <code>pointer 1</code> should result in
<strong>accessing <code>THAT</code></strong>.</p></li>
</ul>
<p><img src="/2024/04/09/7-5-%E5%86%85%E5%AD%98%E6%AE%B5%E7%9A%84%E5%AE%9E%E7%8E%B0/image-8.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/08/7-4-%E5%A0%86%E6%A0%88%E7%BB%93%E6%9E%84%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/08/7-4-%E5%A0%86%E6%A0%88%E7%BB%93%E6%9E%84%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">7.4.&#x5806;&#x6808;&#x7ED3;&#x6784;&#x5B9E;&#x73B0;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-08 18:24:16" itemprop="dateCreated datePublished" datetime="2024-04-08T18:24:16+08:00">2024-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 08:06:14" itemprop="dateModified" datetime="2024-06-03T08:06:14+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="74implementation-of-stack"><span class="math inline">\(7.4.\)</span>Implementation of Stack</span></h1>
<h3><span id="1pointer-manipulation">1.Pointer manipulation</span></h3>
<p>&#x2003;&#x2003;We first introduce <em>pointer notation</em>: <code>*p</code>
represents <strong>the value stores in the address that <code>p</code>
points to</strong>.</p>
<p><img src="/2024/04/08/7-4-%E5%A0%86%E6%A0%88%E7%BB%93%E6%9E%84%E5%AE%9E%E7%8E%B0/image.png"></p>
<p>&#x2003;&#x2003;In <em>Hack</em>, the pointer statement:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D = *p // D becomes 23</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;can be translated into:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@p</span><br><span class="line">A = M</span><br><span class="line">D = M</span><br></pre></td></tr></table></figure>
<ul>
<li><code>A = M</code> points the pointer to the address of register
M.</li>
<li><code>D = M</code> gets the value of the RAM.</li>
</ul>
<p>&#x2003;&#x2003;The calculation of pointer, such as:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p--</span><br><span class="line">D = *p</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;When <code>p--</code>, <code>*p</code> refers to
<code>RAM[256]</code>. After than when we invoke <code>D = *p</code>, it
will get the value stored in <code>RAM[256]</code>, namely 19.</p>
<p>&#x2003;&#x2003;When we assign a number to pointer, such as: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*q = 9</span><br><span class="line">q++</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;The <code>*q</code> refers to <code>RAM[1024]</code>, which stores
value 5. After the assignment, <code>RAM[1024]</code>stores 9
instead.</p>
<h3><span id="2stack-machine-operation">2.Stack machine operation</span></h3>
<p>&#x2003;&#x2003;Before implementation, we make two assumption:</p>
<ol type="1">
<li>The stack pointer will be stored in <code>RAM[0]</code>.</li>
<li>Stack base address will be <code>addr = 256</code>.</li>
</ol>
<p>&#x2003;&#x2003;Let&apos;s <code>push</code> two value first:</p>
<p><img src="/2024/04/08/7-4-%E5%A0%86%E6%A0%88%E7%BB%93%E6%9E%84%E5%AE%9E%E7%8E%B0/image-1.png"></p>
<p>&#x2003;&#x2003;After the <code>push</code>, the stack pointer will point to 258,
and our RAM looks like this:</p>
<p><img src="/2024/04/08/7-4-%E5%A0%86%E6%A0%88%E7%BB%93%E6%9E%84%E5%AE%9E%E7%8E%B0/image-2.png"></p>
<p>&#x2003;&#x2003;And we push <code>12 + 5</code> into the stack, then 17 will be in
the previous available space, and stack pointer moves forward:</p>
<p><img src="/2024/04/08/7-4-%E5%A0%86%E6%A0%88%E7%BB%93%E6%9E%84%E5%AE%9E%E7%8E%B0/image-3.png"></p>
<p>&#x2003;&#x2003;So we can write the VM code: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//push x</span><br><span class="line">*sp = x</span><br><span class="line">sp++</span><br></pre></td></tr></table></figure></p>
<p>&#x2003;&#x2003;This can be translated into this Hack assembly: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//push x</span><br><span class="line">@x</span><br><span class="line">D = A // D = x</span><br><span class="line">@SP</span><br><span class="line">A = M // *sp = D</span><br><span class="line">M = D</span><br><span class="line">@SP //increase the location</span><br><span class="line">M = M + 1</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>&#x2003;&#x2003;In this program, the A register plays two roles: &#x2003;&#x2003;<em>Data
register</em> which stores x &#x2003;&#x2003;<em>Address register</em> as usual</p>
</blockquote>
<h3><span id="3vm-translator-perspective">3.VM translator perspective</span></h3>
<p><img src="/2024/04/08/7-4-%E5%A0%86%E6%A0%88%E7%BB%93%E6%9E%84%E5%AE%9E%E7%8E%B0/image-4.png"></p>
<ul>
<li><p>VM translator is:</p>
<ul>
<li>A program that translates VM code into machine language.</li>
<li>Each VM command generates several assembly commands.</li>
</ul></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">7.2.VM&#x7ED3;&#x6784;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-08 15:54:36" itemprop="dateCreated datePublished" datetime="2024-04-08T15:54:36+08:00">2024-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 07:57:13" itemprop="dateModified" datetime="2024-06-03T07:57:13+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-7-VM-Machine/" itemprop="url" rel="index"><span itemprop="name">Module 7.VM Machine</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="72vm-abstractionthe-stack"><span class="math inline">\(7.2.\)</span>VM Abstraction&#x2014;&#x2014;the Stack</span></h1>
<h3><span id="1-the-stack-machine">1. The stack machine</span></h3>
<ul>
<li>The stack machine is an <em>abstraction</em> that consists of
<strong>an architecture, a stack and a set of operation which we can
apply to the architecture</strong>.</li>
</ul>
<p><img src="/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/image.png"></p>
<ul>
<li>It can be considered an <em>array</em> which offers direct access to
every element in the memory, as oppose to the traditional stack which
only offers a stack pointer.</li>
<li>When we do <code>push x</code>, <strong>the address of
<code>x</code></strong> will be push into the stack:</li>
</ul>
<p><img src="/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/image-1.png"></p>
<ul>
<li><p>When we do <code>pop y</code>:</p>
<ul>
<li>the <strong>current top value in the stack</strong> will be
removed,</li>
<li>the <strong>popped value</strong> will override <code>y</code> (in
this example, when 7 is popped, 3 becomes the new top value).</li>
</ul></li>
</ul>
<p><img src="/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/image-2.png"></p>
<h3><span id="2stack-arithmetic">2.Stack arithmetic</span></h3>
<p>&#x2003;&#x2003;If we want to apply a certain function on the stack, we have to do
three different things:</p>
<ol type="1">
<li>Pop as many required operands in the stack as possible.</li>
<li>Apply the function to these operands in a separate process and get
the result.</li>
<li>Push the result back into the stack.</li>
</ol>
<p><img src="/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/image-3.png"></p>
<p>&#x2003;&#x2003;The obstruction supports all these operations inherently, all we
have to do it to call <code>add</code> or <code>neg</code>, and these
things will take place.</p>
<p><img src="/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/image-4.png"></p>
<h3><span id="3vm-commands">3.VM commands</span></h3>
<ul>
<li>Arithmetic commands:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// d = (2 - x) + (y + 9)</span><br><span class="line">push 2</span><br><span class="line">push x</span><br><span class="line">sub</span><br><span class="line">push y</span><br><span class="line">push 9</span><br><span class="line">add</span><br><span class="line">add </span><br><span class="line">pop d</span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/image-5.png"></p>
<ul>
<li>Logic commands: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// (x &lt; 7) or (y == 8)</span><br><span class="line">push x </span><br><span class="line">push 7</span><br><span class="line">lt</span><br><span class="line">push y</span><br><span class="line">push 8</span><br><span class="line">eq </span><br><span class="line">or</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/image-6.png"></p>
<p>&#x2003;&#x2003;Where do these commands come from? It&apos;s compiled from the
high-level language:</p>
<p><img src="/2024/04/08/7-2-VM%E7%BB%93%E6%9E%84/image-7.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="&#x4E0A;&#x4E00;&#x9875;" aria-label="&#x4E0A;&#x4E00;&#x9875;" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&#x2026;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&#x2026;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" title="&#x4E0B;&#x4E00;&#x9875;" aria-label="&#x4E0B;&#x4E00;&#x9875;" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">



  <div class="copyright">
    &#xA9; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">fyerfyer</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="&#x603B;&#x8BBF;&#x5BA2;&#x91CF;">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="&#x603B;&#x8BBF;&#x95EE;&#x91CF;">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">&#x7531; <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> &#x5F3A;&#x529B;&#x9A71;&#x52A8;
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script src="/js/third-party/comments/livere.js"></script>

</body>
</html>
