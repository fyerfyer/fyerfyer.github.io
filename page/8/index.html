<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fyerfyer.github.io.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":2,"unescape":true,"preload":false}}</script><script src="/js/config.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">


    <meta name="description" content="fyerfyer&apos;s blog">
<meta property="og:type" content="website">
<meta property="og:title" content="fyerfyer">
<meta property="og:url" content="https://fyerfyer.github.io.com/page/8/index.html">
<meta property="og:site_name" content="fyerfyer">
<meta property="og:description" content="fyerfyer&apos;s blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="fyerfyer">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fyerfyer.github.io.com/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>fyerfyer</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="&#x5207;&#x6362;&#x5BFC;&#x822A;&#x680F;" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">fyerfyer</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Hello! Nice to meet you!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="&#x641C;&#x7D22;" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>&#x9996;&#x9875;</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>&#x5173;&#x4E8E;</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>&#x5206;&#x7C7B;</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>&#x5F52;&#x6863;</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>&#x641C;&#x7D22;
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="&#x641C;&#x7D22;..." spellcheck="false" type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          &#x6587;&#x7AE0;&#x76EE;&#x5F55;
        </li>
        <li class="sidebar-nav-overview">
          &#x7AD9;&#x70B9;&#x6982;&#x89C8;
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="fyerfyer" src="/images/head.png">
  <p class="site-author-name" itemprop="name">fyerfyer</p>
  <div class="site-description" itemprop="description">fyerfyer&apos;s blog</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">123</span>
          <span class="site-state-item-name">&#x65E5;&#x5FD7;</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">&#x5206;&#x7C7B;</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/fyerfyer" title="GitHub &#x2192; https://github.com/fyerfyer" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/fuy60703@gmail.com" title="E-Mail &#x2192; fuy60703@gmail.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="&#x8FD4;&#x56DE;&#x9876;&#x90E8;">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/05/19/1-2-Number-Representation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/19/1-2-Number-Representation/" class="post-title-link" itemprop="url">1.2.Number Representation</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-05-19 10:31:00" itemprop="dateCreated datePublished" datetime="2024-05-19T10:31:00+08:00">2024-05-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 18:03:59" itemprop="dateModified" datetime="2024-06-03T18:03:59+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CS61C-Great-Ideas-in-Computer-Architecture/" itemprop="url" rel="index"><span itemprop="name">CS61C Great Ideas in Computer Architecture</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CS61C-Great-Ideas-in-Computer-Architecture/Module-1-Intro/" itemprop="url" rel="index"><span itemprop="name">Module 1.Intro</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>64</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>1 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="121212number-representation"> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.2.</mn></mrow><annotation encoding="application/x-tex">1.2.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span><span class="mord">.</span></span></span></span>Number Representation</span></h1>
<h3><span id="1binary-representation"> 1.Binary representation</span></h3>
<p><img src="/2024/05/19/1-2-Number-Representation/image.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-1.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-2.png" alt></p>
<ul>
<li>We move -1 to the right by one, -2 to the right, etc. Then the two 0s overlap:</li>
</ul>
<p><img src="/2024/05/19/1-2-Number-Representation/image-3.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-4.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-5.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-6.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-7.png" alt></p>
<h3><span id="2bias-encoding"> 2.Bias encoding</span></h3>
<p><img src="/2024/05/19/1-2-Number-Representation/image-8.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-9.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-10.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-11.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-12.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-13.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-14.png" alt></p>
<ul>
<li>Because the biased number are all <strong>start at 0</strong>, <strong>the MSB doesn&#x2019;t represent the sign anymore</strong>. So in floating point, we can compare two biased number directly as if they were unsigned number.</li>
</ul>
<h3><span id="3iec-standard-prefixes"> 3.IEC standard prefixes</span></h3>
<p><img src="/2024/05/19/1-2-Number-Representation/image-15.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-16.png" alt></p>
<p><img src="/2024/05/19/1-2-Number-Representation/image-17.png" alt></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/05/18/1-1-Great-Idea-Intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/18/1-1-Great-Idea-Intro/" class="post-title-link" itemprop="url">1.1.Great Indea Intro</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-05-18 11:31:00" itemprop="dateCreated datePublished" datetime="2024-05-18T11:31:00+08:00">2024-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 17:55:57" itemprop="dateModified" datetime="2024-06-03T17:55:57+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CS61C-Great-Ideas-in-Computer-Architecture/" itemprop="url" rel="index"><span itemprop="name">CS61C Great Ideas in Computer Architecture</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CS61C-Great-Ideas-in-Computer-Architecture/Module-1-Intro/" itemprop="url" rel="index"><span itemprop="name">Module 1.Intro</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>197</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>1 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3><span id="1cs61c-intro"> 1.CS61C intro</span></h3>
<p><img src="/2024/05/18/1-1-Great-Idea-Intro/image-4.png" alt></p>
<ul>
<li>The hareware is composed of <strong>a gazillion computers in parallel</strong>.</li>
<li>The computers are consisted of <strong>parallel computers within the processing unit</strong>.</li>
<li>We get parallelism all the way down the stack.</li>
</ul>
<p><img src="/2024/05/18/1-1-Great-Idea-Intro/image-5.png" alt></p>
<h3><span id="2abstraction"> 2.Abstraction</span></h3>
<p><img src="/2024/05/18/1-1-Great-Idea-Intro/image.png" alt></p>
<ul>
<li>Each level of abstraction is only influenced by <strong>the level above or below by one</strong>.</li>
<li>We can change out the architecture and keep the same machine language to make program run faster.</li>
</ul>
<h3><span id="3moores-law"> 3.Moore&#x2019;s law</span></h3>
<p><img src="/2024/05/18/1-1-Great-Idea-Intro/image-1.png" alt></p>
<ul>
<li><em>Moore&#x2019;s law</em>: Over time, the number of transistors that&#x2019;s actual switches keeps growing exponentially.</li>
<li>However, we hit a brick wall that getting more performance is no longer a matter of improving processes and adding transistors, but <strong>exploiting parallelsome</strong>.</li>
</ul>
<h3><span id="4localitymemory-hierarchy"> 4.Locality/Memory Hierarchy</span></h3>
<ul>
<li>It&#x2019;s about <strong>how far away is a piece of data</strong>.</li>
</ul>
<p><img src="/2024/05/18/1-1-Great-Idea-Intro/image-2.png" alt></p>
<p><img src="/2024/05/18/1-1-Great-Idea-Intro/image-3.png" alt></p>
<h3><span id="5parallelism"> 5.Parallelism</span></h3>
<ul>
<li>We do lots of things at once, even within the most processor.</li>
<li>On the program, we spilt things up.</li>
</ul>
<p><img src="/2024/05/18/1-1-Great-Idea-Intro/image-6.png" alt></p>
<ul>
<li>However, there&#x2019;s a limit called <em>Amdahl&#x2019;s Law</em>: The amount you can speed up something by parallelization depends on <strong>the amount that&#x2019;s actually parallelizable</strong>. If the problem isn&#x2019;t parallelizable, then it will fail.</li>
</ul>
<h3><span id="6dependability-via-redundancy"> 6.Dependability via redundancy</span></h3>
<ul>
<li>To deal with failures, we use <em>redundancy</em> so that a failing piece doesn&#x2019;t make the whole thing fail:</li>
</ul>
<p><img src="/2024/05/18/1-1-Great-Idea-Intro/image-7.png" alt></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/05/04/10-11-%E7%BC%96%E8%AF%91%E5%99%A8%E5%AE%9E%E7%8E%B0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/04/10-11-%E7%BC%96%E8%AF%91%E5%99%A8%E5%AE%9E%E7%8E%B0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">10.11.&#x7F16;&#x8BD1;&#x5668;&#x5B9E;&#x73B0;&#x7B14;&#x8BB0;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-05-04 20:15:43" itemprop="dateCreated datePublished" datetime="2024-05-04T20:15:43+08:00">2024-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 16:06:53" itemprop="dateModified" datetime="2024-06-03T16:06:53+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-10-Code-Generator/" itemprop="url" rel="index"><span itemprop="name">Module 10.Code Generator</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>4.2k</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>15 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="101110111011&#x7F16;&#x8BD1;&#x5668;&#x5B9E;&#x73B0;&#x7B14;&#x8BB0;"> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10.11.</mn></mrow><annotation encoding="application/x-tex">10.11.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">1</span><span class="mord">.</span></span></span></span>&#x7F16;&#x8BD1;&#x5668;&#x5B9E;&#x73B0;&#x7B14;&#x8BB0;</span></h1>
<h3><span id="1symbol-table&#x5B9E;&#x73B0;"> 1.<code>Symbol Table</code>&#x5B9E;&#x73B0;</span></h3>
<p>&#x2003;&#x2003;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x8BFB;&#x53D6;&#x5355;&#x4E00;&#x5B57;&#x7B26;&#xFF0C;&#x6211;&#x4EEC;&#x9009;&#x62E9;<strong>&#x5229;&#x7528;<code>tokenizer</code>&#x751F;&#x6210;&#x7684;&#x4EE3;&#x7801;</strong>&#x6765;&#x6784;&#x5EFA;&#x6211;&#x4EEC;&#x7684;<code>Symbol Table</code>.</p>
<h4><span id="aaa&#x51C6;&#x5907;&#x5DE5;&#x4F5C;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">a.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span><span class="mord">.</span></span></span></span>&#x51C6;&#x5907;&#x5DE5;&#x4F5C;</span></h4>
<ol>
<li>&#x867D;&#x7136;&#x7406;&#x8BBA;&#x4E0A;&#x5E94;&#x8BE5;&#x5BF9;&#x4E8E;&#x6BCF;&#x4E00;&#x4E2A;&#x5B50;&#x7A0B;&#x5E8F;&#xFF0C;&#x6211;&#x4EEC;&#x90FD;&#x5E94;&#x8BE5;&#x5B9E;&#x65F6;&#x5730;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x5BF9;&#x5E94;&#x7684;<code>subroutineMap</code>&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x8F83;&#x96BE;&#x5B9E;&#x73B0;&#xFF0C;&#x6211;&#x9009;&#x62E9;&#x904D;&#x5386;&#x6574;&#x4E2A;&#x7A0B;&#x5E8F;&#x540E;&#xFF0C;&#x5C06;&#x6BCF;&#x4E2A;&#x5B50;&#x7A0B;&#x5E8F;&#x5BF9;&#x5E94;&#x7684;<code>subroutineMap</code>&#x7528;&#x4E00;&#x4E2A;&#x65B0;&#x7684;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>a</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">Map</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span></span></span></span>&#x6765;&#x5B58;&#x50A8;&#xFF1A;</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//for convenience, we store the symbolTable of each subroutine into a map.</span></span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Map&lt;String, Integer&gt;&gt; mapOfSubVar = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Map&lt;String, String&gt;&gt; mapOfSubVarType = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Map&lt;String, String&gt;&gt; mapOfSubVarKind = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Integer&gt; subroutineVar = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; typeOfSubroutineVar = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; kindOfSubroutineVar = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;&#x540C;&#x65F6;&#xFF0C;&#x8FD9;&#x8981;&#x6C42;&#x6211;&#x4EEC;&#x8BB0;&#x5F55;&#x4E0B;&#x5F53;&#x524D;&#x904D;&#x5386;&#x7684;&#x5B50;&#x7A0B;&#x5E8F;&#x7684;&#x540D;&#x79F0;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">StringBuilder</span> <span class="variable">currentStringName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>&#x7531;&#x4E8E;&#x5BF9;&#x6BCF;&#x4E2A;<code>class</code>&#xFF0C;&#x6211;&#x4EEC;&#x90FD;&#x8981;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x65B0;&#x7684;<code>Symbol Table</code>&#xFF0C; &#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x5728;&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x7684;<code>Symbol Table</code>&#x524D;&#x5148;&#x8981;&#x5BF9;&#x50A8;&#x5B58;&#x8868;&#x683C;&#x7684;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>a</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">Map</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span></span></span></span>&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;&#xFF1A;</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startClass</span><span class="params">()</span> {</span><br><span class="line">    classVar.clear();</span><br><span class="line">    typeOfClassVar.clear();</span><br><span class="line">    kindOfClassVar.clear();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>&#x5728;&#x540E;&#x7EED;&#x751F;&#x6210;VM&#x4EE3;&#x7801;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6BCF;&#x4E2A;&#x53D8;&#x91CF;&#x5BF9;&#x5E94;&#x7684;&#x5E8F;&#x53F7;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x53D8;&#x91CF;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x5B58;&#x50A8;&#xFF1A;</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#xA0; &#xA0; <span class="comment">//use to return the kind index</span></span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">classNum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">argNum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">localNum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//and for subroutine, we store their argNum and localNum</span></span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Integer&gt; subroutineArgNum = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Integer&gt; subroutineLCLNum = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>
<h4><span id="bbb&#x7C7B;&#x53D8;&#x91CF;&#x5904;&#x7406;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">b.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span><span class="mord">.</span></span></span></span>&#x7C7B;&#x53D8;&#x91CF;&#x5904;&#x7406;</span></h4>
<p>&#x2003;&#x2003;&#x7C7B;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x53D8;&#x91CF;&#x9075;&#x5FAA;&#x4EE5;&#x4E0B;&#x7ED3;&#x6784;&#xFF1A;</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>k</mi><mi>i</mi><mi>n</mi><mi>d</mi><mo>+</mo><mi>t</mi><mi>y</mi><mi>p</mi><mi>e</mi><mo>+</mo><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mo stretchy="false">(</mo><mo separator="true">,</mo><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mo stretchy="false">)</mo><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex">kind+type+name(,name);
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mpunct">;</span></span></span></span></span></p>
<p>&#x2003;&#x2003;&#x7531;&#x4E8E;&#x8BE5;&#x7ED3;&#x6784;&#x5177;&#x6709;&#x666E;&#x9002;&#x6027;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7528;<strong>&#x9012;&#x5F52;</strong>&#x7684;&#x65B9;&#x6CD5;&#x8BFB;&#x53D6;&#x5E76;&#x5904;&#x7406;&#x6211;&#x4EEC;&#x8BFB;&#x5165;&#x7684;<em>token</em>&#xFF1A;</p>
<ol>
<li>&#x5904;&#x7406;&#x4E00;&#x5B9A;&#x5B58;&#x5728;&#x7684;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi>i</mi><mi>n</mi><mi>d</mi><mo>+</mo><mi>t</mi><mi>y</mi><mi>p</mi><mi>e</mi><mo>+</mo><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">kind+type+name</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span></span></span></span>.</li>
<li>&#x5224;&#x65AD;&#x662F;&#x5426;&#x6709;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo separator="true">,</mo><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">,name</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span></span></span></span>&#x90E8;&#x5206;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7684;&#x8BDD;&#x8FDB;&#x884C;&#x5904;&#x7406;.</li>
<li>&#x9012;&#x5F52;&#x6267;&#x884C;&#x4E0A;&#x8FF0;&#x6B65;&#x9AA4;&#xFF0C;&#x76F4;&#x81F3;&#x4E0B;&#x4E00;&#x4E2A;&#x4F20;&#x5165;&#x53D8;&#x91CF;&#x4E0D;&#x662F;<code>local</code>&#x53D8;&#x91CF;.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dealClassVar</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">if</span> (Tokenizer.getNextString().equals(<span class="string">&quot;field&quot;</span>) || Tokenizer.getNextString().equals(<span class="string">&quot;static&quot;</span>)) {</span><br><span class="line">        <span class="comment">// get the kind</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classVarKind</span> <span class="operator">=</span> Tokenizer.stringAdvance();</span><br><span class="line">        <span class="comment">// get the type</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classVarType</span> <span class="operator">=</span> Tokenizer.stringAdvance();</span><br><span class="line">        <span class="comment">// get the name</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classVarName</span> <span class="operator">=</span> Tokenizer.stringAdvance();</span><br><span class="line">        <span class="comment">// add to correspond kind</span></span><br><span class="line">        <span class="keyword">if</span> (classVarKind.equals(<span class="string">&quot;static&quot;</span>)) {</span><br><span class="line">            classVar.put(classVarName, classNum++);</span><br><span class="line">            typeOfClassVar.put(classVarName, classVarType);</span><br><span class="line">            kindOfClassVar.put(classVarName, <span class="string">&quot;this&quot;</span>);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (classVarKind.equals(<span class="string">&quot;field&quot;</span>)) {</span><br><span class="line">            classVar.put(classVarName, classNum++);</span><br><span class="line">            typeOfClassVar.put(classVarName, classVarType);</span><br><span class="line">            kindOfClassVar.put(classVarName, <span class="string">&quot;this&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// if there&apos;s a &apos;,&apos;, there remains some vars</span></span><br><span class="line">        <span class="keyword">while</span> (Tokenizer.getNextString().equals(<span class="string">&quot;,&quot;</span>)) {</span><br><span class="line">            Tokenizer.stringAdvance();</span><br><span class="line">            <span class="type">String</span> <span class="variable">nextName</span> <span class="operator">=</span> Tokenizer.stringAdvance();</span><br><span class="line">            <span class="comment">// after the operation, there will be &apos;,&apos; or &apos;;&apos;</span></span><br><span class="line">            <span class="keyword">if</span> (classVarKind.equals(<span class="string">&quot;static&quot;</span>)) {</span><br><span class="line">                classVar.put(nextName, classNum++);</span><br><span class="line">                typeOfClassVar.put(nextName, classVarType);</span><br><span class="line">                kindOfClassVar.put(nextName, <span class="string">&quot;this&quot;</span>);</span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (classVarKind.equals(<span class="string">&quot;field&quot;</span>)) {</span><br><span class="line">                classVar.put(nextName, classNum++);</span><br><span class="line">                typeOfClassVar.put(nextName, classVarType);</span><br><span class="line">                kindOfClassVar.put(nextName, <span class="string">&quot;this&quot;</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// then we meets &apos;;&apos;, we skip it</span></span><br><span class="line">        Tokenizer.stringAdvance();</span><br><span class="line">        <span class="comment">// we continuously deal with rest classVar recursively</span></span><br><span class="line">        <span class="keyword">if</span> (Tokenizer.getNextString().equals(<span class="string">&quot;field&quot;</span>) || Tokenizer.getNextString().equals(<span class="string">&quot;static&quot;</span>)) {</span><br><span class="line">            dealClassVar();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// finally, update the current string</span></span><br><span class="line">        currentStringName.setLength(<span class="number">0</span>);</span><br><span class="line">        currentStringName.append(Tokenizer.stringAdvance());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4><span id="ccc&#x5B50;&#x7A0B;&#x5E8F;&#x53D8;&#x91CF;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">c.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span></span></span></span>&#x5B50;&#x7A0B;&#x5E8F;&#x53D8;&#x91CF;</span></h4>
<p>&#x2003;&#x2003;&#x5B50;&#x7A0B;&#x5E8F;&#x53D8;&#x91CF;&#x7ED3;&#x6784;&#x4E0E;&#x7C7B;&#x53D8;&#x91CF;&#x76F8;&#x4F3C;&#xFF0C;&#x8FD9;&#x91CC;&#x7565;&#x8FC7;&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF1A;&#x5B50;&#x7A0B;&#x5E8F;&#x4E2D;&#x5305;&#x542B;&#x53C2;&#x6570;&#x53D8;&#x91CF;&#xFF0C;&#x8FD9;&#x4E5F;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x7EB3;&#x5165;&#x8003;&#x8651;&#x7684;&#x8303;&#x7574;&#xFF1A;</p>
<ul>
<li>&#x5BF9;&#x53C2;&#x6570;&#x7684;&#x5904;&#x7406;&#xFF1A;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dealFuncArgVar</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">//the function features: Dec + type + funcName + ( + args + )</span></span><br><span class="line">    <span class="comment">//so we need to ignore the irrelevant elements</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">subroutineType</span> <span class="operator">=</span> Tokenizer.stringAdvance();</span><br><span class="line">    currentSubroutineName.setLength(<span class="number">0</span>);</span><br><span class="line">    currentSubroutineName.append(className + <span class="string">&quot;.&quot;</span>);</span><br><span class="line">    currentSubroutineName.append(Tokenizer.stringAdvance());</span><br><span class="line">    Tokenizer.stringAdvance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//we continue read the arguments until we meet &quot;)&quot;</span></span><br><span class="line">    <span class="keyword">while</span> (!Tokenizer.getNextString().equals(<span class="string">&quot;)&quot;</span>)) {</span><br><span class="line">        <span class="comment">// type + name</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> Tokenizer.stringAdvance();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Tokenizer.stringAdvance();</span><br><span class="line">        subroutineVar.put(name, argNum++);</span><br><span class="line">        typeOfSubroutineVar.put(name, type);</span><br><span class="line">        kindOfSubroutineVar.put(name, <span class="string">&quot;argument&quot;</span>);</span><br><span class="line">        <span class="comment">//if there&apos;s a &apos;,&apos;, then we have more args</span></span><br><span class="line">        <span class="keyword">while</span> (Tokenizer.getNextString().equals(<span class="string">&quot;,&quot;</span>)) {</span><br><span class="line">            <span class="comment">//ignore the &apos;,&apos;</span></span><br><span class="line">            Tokenizer.stringAdvance();</span><br><span class="line">            type = Tokenizer.stringAdvance();</span><br><span class="line">            name = Tokenizer.stringAdvance();</span><br><span class="line">            subroutineVar.put(name, argNum++);</span><br><span class="line">            typeOfSubroutineVar.put(name, type);</span><br><span class="line">            kindOfSubroutineVar.put(name, <span class="string">&quot;argument&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//we ignore the &quot;)&quot;</span></span><br><span class="line">    Tokenizer.stringAdvance();</span><br><span class="line">    <span class="comment">//then we ignore the &quot;{&quot;</span></span><br><span class="line">    Tokenizer.stringAdvance();</span><br><span class="line">    currentStringName.setLength(<span class="number">0</span>);</span><br><span class="line">    currentStringName.append(Tokenizer.stringAdvance());</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>&#x5BF9;&#x7A0B;&#x5E8F;&#x4F53;&#x5185;&#x90E8;&#x53D8;&#x91CF;&#x7684;&#x5904;&#x7406;&#xFF1A;</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dealFuncLCLVar</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">if</span> (currentStringName.toString().equals(<span class="string">&quot;var&quot;</span>)) {</span><br><span class="line">        <span class="comment">//var + type + name</span></span><br><span class="line">        <span class="comment">//we skip var first</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> Tokenizer.stringAdvance();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Tokenizer.stringAdvance();</span><br><span class="line"></span><br><span class="line">        subroutineVar.put(name, localNum++);</span><br><span class="line">        typeOfSubroutineVar.put(name, type);</span><br><span class="line">        kindOfSubroutineVar.put(name, <span class="string">&quot;local&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//deal with &quot;,&quot;</span></span><br><span class="line">        <span class="keyword">while</span> (Tokenizer.getNextString().equals(<span class="string">&quot;,&quot;</span>)) {</span><br><span class="line">            Tokenizer.stringAdvance();</span><br><span class="line">            name = Tokenizer.stringAdvance();</span><br><span class="line">            subroutineVar.put(name, localNum++);</span><br><span class="line">            typeOfSubroutineVar.put(name, type);</span><br><span class="line">            kindOfSubroutineVar.put(name, <span class="string">&quot;local&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//we meet a &quot;;&quot;</span></span><br><span class="line">    Tokenizer.stringAdvance();</span><br><span class="line">    currentStringName.setLength(<span class="number">0</span>);</span><br><span class="line">    currentStringName.append(Tokenizer.stringAdvance());</span><br><span class="line">    <span class="keyword">if</span> (currentStringName.toString().equals(<span class="string">&quot;var&quot;</span>)) dealFuncLCLVar();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; }</span><br></pre></td></tr></table></figure>
<h4><span id="dddsymbol-table&#x6700;&#x7EC8;&#x6784;&#x5EFA;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">d.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span><span class="mord">.</span></span></span></span><code>Symbol Table</code>&#x6700;&#x7EC8;&#x6784;&#x5EFA;</span></h4>
<p>&#x2003;&#x2003;&#x6709;&#x4E86;&#x4E0A;&#x8FF0;&#x65B9;&#x6CD5;&#x7684;&#x94FA;&#x57AB;&#xFF0C; &#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x5728;&#x9047;&#x5230;&#x5BF9;&#x5E94;&#x7684;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">token</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span>&#x65F6;&#x8C03;&#x7528;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#x5373;&#x53EF;&#x3002;&#x6211;&#x4EEC;&#x5229;&#x7528;<code>private static String currentStringName</code>&#x6765;&#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x8BFB;&#x5165;&#x7684;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>o</mi><mi>k</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">token</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span>&#xFF0C;&#x5982;&#x679C;&#x9047;&#x5230;&#x4E86;&#x58F0;&#x660E;&#x7C7B;&#x6216;&#x5B50;&#x7A0B;&#x5E8F;&#x7684;&#x5173;&#x952E;&#x5B57;&#xFF0C;&#x5C31;&#x8DF3;&#x8F6C;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x53D8;&#x91CF;&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF1A;</p>
<ol>
<li>&#x5F53;&#x9047;&#x5230;<code>class</code>&#x5173;&#x952E;&#x5B57;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x5FFD;&#x7565;&#x6389;<span class="katex-error" title="ParseError: KaTeX parse error: Expected &apos;}&apos;, got &apos;EOF&apos; at end of input: &#x2026;ass+className+{">class+className+{</span>&#x540E;&#x7740;&#x624B;&#x5904;&#x7406;&#x7C7B;&#x53D8;&#x91CF;&#xFF1A;</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//if we meet &quot;class&quot;, then we call dealClass</span></span><br><span class="line"><span class="keyword">if</span> (currentStringName.toString().equals(<span class="string">&quot;class&quot;</span>)) {</span><br><span class="line">    startClass();</span><br><span class="line"></span><br><span class="line">    className = Tokenizer.stringAdvance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ignore the &apos;{&apos;</span></span><br><span class="line">    Tokenizer.stringAdvance();</span><br><span class="line"></span><br><span class="line">    dealClassVar();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!currentStringName.toString().equals(<span class="string">&quot;class&quot;</span>)) <span class="keyword">continue</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>&#x5F53;&#x9047;&#x5230;<code>funcDec</code>&#x5173;&#x952E;&#x8BCD;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x5904;&#x7406;<code>varDec</code>&#x90E8;&#x5206;&#xFF0C;&#x5E76;&#x5C06;&#x5F97;&#x5230;&#x7684;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>a</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">Map</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span></span></span></span>&#x5B58;&#x5165;&#x5BF9;&#x5E94;&#x5B50;&#x7A0B;&#x5E8F;&#x7684;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>a</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">Map</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span></span></span></span>&#x4E2D;&#xFF1A;</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (currentStringName.toString().equals(<span class="string">&quot;method&quot;</span>)</span><br><span class="line">        || currentStringName.toString().equals(<span class="string">&quot;function&quot;</span>)</span><br><span class="line">        || currentStringName.toString().equals(<span class="string">&quot;constructor&quot;</span>)) {</span><br><span class="line">    <span class="comment">//deal with the arguments first</span></span><br><span class="line">    startSubroutine();</span><br><span class="line">    <span class="keyword">if</span> (currentStringName.toString().equals(<span class="string">&quot;method&quot;</span>)) startMethod();</span><br><span class="line">    dealFuncArgVar();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//after the argument comes the body of func</span></span><br><span class="line">    <span class="comment">//we only care about varDec</span></span><br><span class="line">    <span class="keyword">if</span> (currentStringName.toString().equals(<span class="string">&quot;var&quot;</span>)) dealFuncLCLVar();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//we copy the current ArrayList and deliver the copyList</span></span><br><span class="line">    Map&lt;String, Integer&gt; copyVar = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(subroutineVar);</span><br><span class="line">    Map&lt;String, String&gt; copyType = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(typeOfSubroutineVar);</span><br><span class="line">    Map&lt;String, String&gt; copyKind = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(kindOfSubroutineVar);</span><br><span class="line"></span><br><span class="line">    mapOfSubVar.put(currentSubroutineName.toString(), copyVar);</span><br><span class="line">    mapOfSubVarType.put(currentSubroutineName.toString(), copyType);</span><br><span class="line">    mapOfSubVarKind.put(currentSubroutineName.toString(), copyKind);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//store the index of arg and lcl</span></span><br><span class="line">    subroutineLCLNum.put(currentSubroutineName.toString(), localNum);</span><br><span class="line">    subroutineArgNum.put(currentSubroutineName.toString(), argNum);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4><span id="ddd&#x4F9B;&#x5176;&#x4ED6;&#x7C7B;&#x4F7F;&#x7528;&#x7684;&#x51FD;&#x6570;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">d.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span><span class="mord">.</span></span></span></span>&#x4F9B;&#x5176;&#x4ED6;&#x7C7B;&#x4F7F;&#x7528;&#x7684;&#x51FD;&#x6570;</span></h4>
<p>&#x2003;&#x2003;&#x5BF9;&#x4E8E;&#x7ED9;&#x5B9A;&#x7684;&#x8F93;&#x5165;&#xFF0C;&#x8FD4;&#x56DE;&#x8BE5;&#x8F93;&#x5165;&#x5728;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>a</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">Map</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span></span></span></span>&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x503C;&#x5373;&#x53EF;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">varCount</span><span class="params">(String <span class="keyword">var</span>, String subroutine)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (subroutine != <span class="literal">null</span> &amp;&amp; mapOfSubVar.get(subroutine).containsKey(<span class="keyword">var</span>))</span><br><span class="line">            <span class="keyword">return</span> mapOfSubVar.get(subroutine).get(<span class="keyword">var</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (classVar.containsKey(<span class="keyword">var</span>))</span><br><span class="line">            <span class="keyword">return</span> classVar.get(<span class="keyword">var</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) {</span><br><span class="line">        System.out.println(<span class="string">&quot;The variable is undefined&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">varType</span><span class="params">(String <span class="keyword">var</span>, String subroutine)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (subroutine != <span class="literal">null</span> &amp;&amp; mapOfSubVarType.get(subroutine).containsKey(<span class="keyword">var</span>))</span><br><span class="line">            <span class="keyword">return</span> mapOfSubVarType.get(subroutine).get(<span class="keyword">var</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (typeOfClassVar.containsKey(<span class="keyword">var</span>))</span><br><span class="line">            <span class="keyword">return</span> typeOfClassVar.get(<span class="keyword">var</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) {</span><br><span class="line">        System.out.println(<span class="string">&quot;The variable is undefined&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">varKind</span><span class="params">(String <span class="keyword">var</span>, String subroutine)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (subroutine != <span class="literal">null</span> &amp;&amp; mapOfSubVarKind.get(subroutine).containsKey(<span class="keyword">var</span>))</span><br><span class="line">            <span class="keyword">return</span> mapOfSubVarKind.get(subroutine).get(<span class="keyword">var</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (kindOfClassVar.containsKey(<span class="keyword">var</span>))</span><br><span class="line">            <span class="keyword">return</span> kindOfClassVar.get(<span class="keyword">var</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) {</span><br><span class="line">        System.out.println(<span class="string">&quot;The variable is undefined.&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//if it&apos;s a classVar, then subroutine is null</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">kindCount</span><span class="params">(String kindName, String subroutine)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">if</span> (subroutine.equals(<span class="string">&quot;Output.printInt&quot;</span>)) <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (kindName.equals(<span class="string">&quot;argument&quot;</span>)) <span class="keyword">return</span> subroutineArgNum.get(subroutine);</span><br><span class="line">        <span class="keyword">if</span> (kindName.equals(<span class="string">&quot;local&quot;</span>)) <span class="keyword">return</span> subroutineLCLNum.get(subroutine);</span><br><span class="line">        <span class="keyword">if</span> (kindName.equals(<span class="string">&quot;field&quot;</span>) || kindName.equals(<span class="string">&quot;static&quot;</span>)) <span class="keyword">return</span> classNum;</span><br><span class="line">    } <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) {</span><br><span class="line">        System.out.println(<span class="string">&quot;The kind is out of range.&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3><span id="2vmwriter&#x5B9E;&#x73B0;"> 2.<code>VMWriter</code>&#x5B9E;&#x73B0;</span></h3>
<p>&#x2003;&#x2003;&#x4E3A;&#x6EE1;&#x8DB3;<code>CompileEngine</code>VM&#x4EE3;&#x7801;&#x7684;&#x751F;&#x6210;&#xFF0C;&#x6211;&#x4EEC;&#x5728;<code>VMWriter</code>&#x4E2D;&#x8BBE;&#x8BA1;&#x4EE5;&#x4E0B;&#x51FD;&#x6570;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">writePush</span><span class="params">(String segment, <span class="type">int</span> index)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">writePop</span><span class="params">(String segment, <span class="type">int</span> index)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">writeOp</span><span class="params">(String command)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">writeUnaryOp</span><span class="params">(String command)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">writeCall</span><span class="params">(String name, <span class="type">int</span> argNum)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">writeFunctionDec</span><span class="params">(String name, <span class="type">int</span> lclNum)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">writeFunctionCall</span><span class="params">(String name, <span class="type">int</span> argNum)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">writeReturn</span><span class="params">()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title function_">writeString</span><span class="params">(String string)</span></span><br></pre></td></tr></table></figure>
<h3><span id="3compileengine&#x5B9E;&#x73B0;"> 3.<code>CompileEngine</code>&#x5B9E;&#x73B0;</span></h3>
<p>&#x2003;&#x2003;&#x5728;<code>CompileEngine</code>&#x4E2D;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x8BFB;&#x5165;&#x5B8C;&#x6574;&#x7684;&#x8868;&#x8FBE;&#x5F0F;&#x4EE5;&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x7684;VM&#x4EE3;&#x7801;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x9009;&#x62E9;&#x76F4;&#x63A5;&#x8BFB;&#x5165;&#x6E90;&#x7A0B;&#x5E8F;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x8BFB;&#x5165;&#x884C;&#x7684;&#x5173;&#x952E;&#x5B57;&#x5224;&#x65AD;&#x5176;&#x8868;&#x8FBE;&#x5F0F;&#x7C7B;&#x578B;&#x3002;</p>
<h4><span id="aaa&#x51C6;&#x5907;&#x5DE5;&#x4F5C;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">a.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span><span class="mord">.</span></span></span></span>&#x51C6;&#x5907;&#x5DE5;&#x4F5C;</span></h4>
<p>&#x2003;&#x2003;&#x4E3A;&#x4E86;&#x9632;&#x6B62;<code>if</code>&#x548C;<code>while</code>&#x7684;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>a</mi><mi>b</mi><mi>e</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">label</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>&#x91CD;&#x590D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;<code>private static int ifLabelCount, whileLabelCount</code>&#x3002;</p>
<p>&#x2003;&#x2003;&#x540C;&#x65F6;&#xFF0C;&#x7531;&#x4E8E;&#x5728;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x65F6;&#x9700;&#x8981;&#x77E5;&#x9053;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x7C7B;&#x578B;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x8981;&#x5728;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;&#x4E2D;&#x5B58;&#x50A8;&#x6211;&#x4EEC;&#x9047;&#x5230;&#x7684;&#x51FD;&#x6570;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; funcType</span><br></pre></td></tr></table></figure>
<h4><span id="bbb&#x8868;&#x8FBE;&#x5F0F;&#x8BA1;&#x7B97;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">b.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span><span class="mord">.</span></span></span></span>&#x8868;&#x8FBE;&#x5F0F;&#x8BA1;&#x7B97;</span></h4>
<p>&#x2003;&#x2003;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#xFF0C;<code>Jack</code>&#x4E2D;&#x7684;&#x8868;&#x8FBE;&#x5F0F;&#x6709;&#x4EE5;&#x4E0B;&#x6027;&#x8D28;&#xFF1A;</p>
<ol>
<li>&#x5F53;&#x6CA1;&#x6709;&#x62EC;&#x53F7;&#x65F6;&#xFF0C;&#x4ECE;&#x5DE6;&#x5230;&#x53F3;&#x4F9D;&#x6B21;&#x8BA1;&#x7B97;&#x3002;</li>
<li>&#x6709;&#x62EC;&#x53F7;&#x65F6;&#xFF0C;&#x4F18;&#x5148;&#x8BA1;&#x7B97;&#x62EC;&#x53F7;&#x5185;&#x5F0F;&#x5B50;&#x3002;</li>
</ol>
<p>&#x2003;&#x2003;&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;<strong>&#x4ECE;&#x5DE6;&#x5F80;&#x53F3;</strong>&#x5904;&#x7406;&#x8F93;&#x5165;&#x7684;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x5E76;<strong>&#x4F18;&#x5148;&#x8003;&#x8651;&#x662F;&#x5426;&#x6709;&#x62EC;&#x53F7;&#xFF0C;&#x5982;&#x679C;&#x9047;&#x5230;&#x62EC;&#x53F7;&#x4F18;&#x5148;&#x5904;&#x7406;&#x62EC;&#x53F7;&#x5185;&#x8BED;&#x53E5;</strong>&#x3002;</p>
<blockquote>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">p.s.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord">.</span></span></span></span>:&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x5148;&#x8BA1;&#x7B97;&#x5185;&#x4FA7;&#x62EC;&#x53F7;&#x3001;&#x518D;&#x8BA1;&#x7B97;&#x5916;&#x4FA7;&#x62EC;&#x53F7;&#xFF0C;&#x4E00;&#x4E2A;&#x81EA;&#x7136;&#x7684;&#x60F3;&#x6CD5;&#x662F;<strong>&#x627E;&#x5230;&#x6700;&#x5185;&#x4FA7;&#x7684;&#x62EC;&#x53F7;&#x5BF9;&#xFF0C;&#x5904;&#x7406;&#x5B8C;&#x5176;&#x5185;&#x90E8;&#x8868;&#x8FBE;&#x5F0F;&#x540E;&#x5C06;&#x5176;&#x62B9;&#x53BB;&#xFF0C;&#x5411;&#x5916;&#x5EF6;&#x5C55;</strong>&#x3002;&#x4F46;&#x662F;&#x8FD9;&#x6837;&#x4E0D;&#x6EE1;&#x8DB3;&#x6027;&#x8D28;&#x4E00;&#xFF0C;&#x56E0;&#x800C;&#x4F1A;&#x5BFC;&#x81F4;&#x5931;&#x8D25;&#x3002;</p>
</blockquote>
<p>&#x2003;&#x2003;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;<strong>&#x6808;</strong>&#x6765;&#x8FDB;&#x884C;&#x62EC;&#x53F7;&#x5BF9;&#x7684;&#x5339;&#x914D;&#xFF0C;&#x7136;&#x540E;&#x8BA1;&#x7B97;&#x5BF9;&#x5E94;&#x4E0B;&#x6807;&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x503C;&#x3002;</p>
<p>&#x2003;&#x2003;&#x5728;<code>Jack</code>&#x8BED;&#x6CD5;&#x4E00;&#x7AE0;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x8868;&#x8FBE;&#x5F0F;&#x5177;&#x6709;&#x5982;&#x4E0B;&#x7ED3;&#x6784;&#xFF1A;</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi><mo stretchy="false">(</mo><mi>o</mi><mi>p</mi><mtext>&#x2005;&#x200A;</mtext><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">expression=term(op\;term)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span></span></p>
<p>&#x2003;&#x2003;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x6CBF;&#x7528;&#x8BE5;&#x7ED3;&#x6784;&#xFF0C;<strong>&#x5229;&#x7528;<code>op</code>&#x5C06;&#x539F;&#x8868;&#x8FBE;&#x5F0F;&#x62C6;&#x5206;&#x6210;&#x4E00;&#x4E2A;&#x4E2A;&#x5B50;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x7136;&#x540E;&#x5206;&#x522B;&#x9012;&#x5F52;&#x8BA1;&#x7B97;</strong>&#x3002;&#x4F46;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x5E76;&#x4E0D;&#x80FD;&#x786E;&#x5B9A;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">term</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span></span></span></span>&#x7684;&#x4E2A;&#x6570;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x5BF9;&#x4E0A;&#x9762;&#x7684;&#x7ED3;&#x6784;&#x8FDB;&#x884C;&#x6539;&#x52A8;&#xFF1A;</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi><mo stretchy="false">(</mo><mi>o</mi><mi>p</mi><mtext>&#x2005;&#x200A;</mtext><mi>e</mi><mi>x</mi><mi>p</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">expression=term(op\;expression)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>&#x2003;&#x2003;&#x8BE5;&#x7ED3;&#x6784;&#x7684;&#x53D8;&#x91CF;&#x4E2A;&#x6570;&#x662F;&#x786E;&#x5B9A;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x5206;&#x522B;&#x9012;&#x5F52;&#x8BA1;&#x7B97;&#x5373;&#x53EF;&#xFF1A;</p>
<blockquote>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi mathvariant="normal">.</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">p.s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span><span class="mord">.</span><span class="mord mathnormal">s</span></span></span></span>&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x68D8;&#x624B;&#x7684;&#x95EE;&#x9898;&#xFF1A;&#x5BF9;&#x4E8E;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mi>n</mi><mi>a</mi><mi>r</mi><mi>y</mi><mtext>&#x2005;&#x200A;</mtext><mi>o</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">unary\;op</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span></span></span></span>&#x7684;&#x5904;&#x7406;&#x3002;&#x5728;<code>-(1+2)</code>&#x8FD9;&#x4E2A;&#x8868;&#x8FBE;&#x5F0F;&#x4E2D;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;<code>-</code>&#x5E76;&#x4E0D;&#x8D77;&#x5230;&#x62C6;&#x5206;&#x7684;&#x4F5C;&#x7528;&#x3002;&#x6CE8;&#x610F;&#x5230;&#x6211;&#x4EEC;&#x662F;&#x4EE5;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">term</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span></span></span></span>&#x4E3A;&#x57FA;&#x672C;&#x5904;&#x7406;&#x5355;&#x5143;&#x7684;&#xFF0C;&#x800C;<strong>&#x5728;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">term</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span></span></span></span>&#x4E2D;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mi>n</mi><mi>a</mi><mi>r</mi><mi>y</mi><mtext>&#x2005;&#x200A;</mtext><mi>o</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">unary\;op</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span></span></span></span>&#x53EA;&#x80FD;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;</strong>&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x4ECE;&#x5DE6;&#x5F80;&#x53F3;&#x8BA1;&#x7B97;&#x524D;<strong>&#x5148;&#x5224;&#x65AD;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x662F;&#x5426;&#x4E3A;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">op</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span></span></span></span>&#xFF0C;&#x5982;&#x679C;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x8BA1;&#x7B97;&#x5B8C;&#x7B2C;&#x4E00;&#x4E2A;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">term</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span></span></span></span>&#x540E;&#x8BB0;&#x5F55;&#x8BE5;&#x8868;&#x8FBE;&#x5F0F;&#xFF1A;</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//if the first character belongs unary op //then we skip it </span></span><br><span class="line"><span class="type">String</span> <span class="variable">unaryOp</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>; </span><br><span class="line"><span class="keyword">if</span> (isOp(line.charAt(<span class="number">0</span>))) { </span><br><span class="line">	unaryOp = Character.toString(line.charAt(<span class="number">0</span>)); </span><br><span class="line">	line = line.substring(<span class="number">1</span>); </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!unaryOp.isEmpty()) expression.add(VMWriter.writeUnaryOp(unaryOp));</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title function_">compileExpression</span><span class="params">(String line)</span> {</span><br><span class="line">    ArrayList&lt;String&gt; expression = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//if the first character belongs unary op</span></span><br><span class="line">    <span class="comment">//then we skip it</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">unaryOp</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (isOp(line.charAt(<span class="number">0</span>))) {</span><br><span class="line">        unaryOp = Character.toString(line.charAt(<span class="number">0</span>));</span><br><span class="line">        line = line.substring(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!containOP(line)) {</span><br><span class="line">        ArrayList&lt;String&gt; term = compileTerm(line);</span><br><span class="line">        expression.addAll(term);</span><br><span class="line">        <span class="keyword">if</span> (!unaryOp.isEmpty())</span><br><span class="line">            expression.add(VMWriter.writeUnaryOp(unaryOp));</span><br><span class="line">        <span class="keyword">return</span> expression;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//if we meet (, deal with it first</span></span><br><span class="line">    <span class="keyword">if</span> (line.charAt(<span class="number">0</span>) == <span class="string">&apos;(&apos;</span>) {</span><br><span class="line">        Stack&lt;Integer&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rightIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; line.length(); i++) {</span><br><span class="line">            <span class="keyword">if</span> (line.charAt(i) == <span class="string">&apos;(&apos;</span>) stack.push(i);</span><br><span class="line">            <span class="keyword">if</span> (line.charAt(i) == <span class="string">&apos;)&apos;</span>) {</span><br><span class="line">                <span class="keyword">if</span> (!stack.isEmpty()) stack.pop();</span><br><span class="line">                <span class="keyword">else</span> {</span><br><span class="line">                    rightIndex = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">termExp</span> <span class="operator">=</span> line.substring(<span class="number">0</span>, rightIndex + <span class="number">1</span>);</span><br><span class="line">        expression.addAll(compileTerm(termExp));</span><br><span class="line">        <span class="keyword">if</span> (!unaryOp.isEmpty()) expression.add(VMWriter.writeUnaryOp(unaryOp));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//if the ) is not the last, then after it comes an op</span></span><br><span class="line">        <span class="comment">//it&apos;s defined by the Jack grammar</span></span><br><span class="line">        <span class="keyword">if</span> (rightIndex &lt; line.length() - <span class="number">1</span>) {</span><br><span class="line">            expression.addAll(compileExpression(line.substring(rightIndex + <span class="number">2</span>)));</span><br><span class="line">            expression.add(VMWriter.writeOp(Character.toString(line.charAt(rightIndex + <span class="number">1</span>))));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> expression;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//we deal with the next op</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">opIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">curOp</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; line.length(); i++) {</span><br><span class="line">        <span class="keyword">if</span> (isOp(line.charAt(i))) {</span><br><span class="line">            opIndex = i;</span><br><span class="line">            curOp = Character.toString(line.charAt(i));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">termExp1</span> <span class="operator">=</span> line.substring(<span class="number">0</span>, opIndex);</span><br><span class="line">    <span class="type">String</span> <span class="variable">termExp2</span> <span class="operator">=</span> line.substring(opIndex + <span class="number">1</span>);</span><br><span class="line">    expression.addAll(compileTerm(termExp1));</span><br><span class="line">    <span class="keyword">if</span> (!unaryOp.isEmpty())</span><br><span class="line">        expression.add(VMWriter.writeUnaryOp(unaryOp));</span><br><span class="line">    <span class="keyword">if</span> (!termExp2.isEmpty())</span><br><span class="line">        expression.addAll(compileExpression(termExp2));</span><br><span class="line">    expression.add(VMWriter.writeOp(curOp));</span><br><span class="line">    <span class="keyword">return</span> expression;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;&#x5BF9;&#x4E8E;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>r</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">term</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.61508em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">m</span></span></span></span>&#x7684;&#x5904;&#x7406;&#x8F83;&#x4E3A;&#x7B80;&#x5355;&#xFF0C;&#x53EA;&#x9700;&#x6CE8;&#x610F;&#x5BF9;&#x51FD;&#x6570;&#x7684;&#x5224;&#x65AD;&#x65B9;&#x5F0F;&#x5373;&#x53EF;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title function_">compileTerm</span><span class="params">(String line)</span> {</span><br><span class="line">    ArrayList&lt;String&gt; term = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (line.matches(<span class="string">&quot;-?\\d+&quot;</span>)) {</span><br><span class="line">        term.add(VMWriter.writePush(<span class="string">&quot;constant&quot;</span>, Integer.parseInt(line)));</span><br><span class="line">        <span class="keyword">return</span> term;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (line.contains(<span class="string">&quot;(&quot;</span>)) {</span><br><span class="line">        <span class="comment">//if the first is &quot;(&quot;, then it&apos;s (expression)</span></span><br><span class="line">        <span class="keyword">if</span> (line.charAt(<span class="number">0</span>) == <span class="string">&apos;(&apos;</span>) {</span><br><span class="line">            term.addAll(compileExpression(line.substring(<span class="number">1</span>, line.length() - <span class="number">1</span>)));</span><br><span class="line">            <span class="keyword">return</span> term;</span><br><span class="line">        } <span class="keyword">else</span> { <span class="comment">//else, it&apos;s a functionCall</span></span><br><span class="line">            ArrayList&lt;String&gt; functionCall = compileSubroutineCall(line);</span><br><span class="line">            term.addAll(functionCall);</span><br><span class="line">            <span class="keyword">return</span> term;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//if line contains &apos;[&apos;, it must be an array</span></span><br><span class="line">    <span class="keyword">if</span> (line.contains(<span class="string">&quot;[&quot;</span>)) {</span><br><span class="line">        term.addAll(compileArray(line));</span><br><span class="line">        <span class="keyword">return</span> term;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//if it&apos;s a stringConstant, we use string method to append char by char</span></span><br><span class="line">    <span class="keyword">if</span> (line.charAt(<span class="number">0</span>) == <span class="string">&apos;&quot;&apos;</span>) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> line.substring(<span class="number">1</span>, line.length() - <span class="number">1</span>);</span><br><span class="line">        term.addAll(VMWriter.writeString(string));</span><br><span class="line">        <span class="keyword">return</span> term;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//else, it&apos;s a variable</span></span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        term.add(VMWriter.writePush(SymbolTable.varKind(line, curSubroutine.toString()), SymbolTable.varCount(line, curSubroutine.toString())));</span><br><span class="line">        <span class="keyword">return</span> term;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4><span id="cccreturn&#x8BED;&#x53E5;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">c.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span><span class="mord">.</span></span></span></span><code>return</code>&#x8BED;&#x53E5;</span></h4>
<p>&#x2003;&#x2003;&#x6839;&#x636E;<code>return</code>&#x53D8;&#x91CF;&#x8FDB;&#x884C;&#x5206;&#x7C7B;&#x5904;&#x7406;&#x5373;&#x53EF;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title function_">compileReturnStatement</span><span class="params">(String line)</span> {</span><br><span class="line">    ArrayList&lt;String&gt; returnStatement = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Extract the return value from the line</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">returnVal</span> <span class="operator">=</span> line.substring(<span class="number">6</span>, line.indexOf(<span class="string">&quot;;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!returnVal.isEmpty()) {</span><br><span class="line">        <span class="keyword">if</span> (isKeywordConstant(returnVal)) {</span><br><span class="line">            <span class="comment">// Handle keyword constants</span></span><br><span class="line">            <span class="keyword">if</span> (returnVal.equals(<span class="string">&quot;this&quot;</span>)) {</span><br><span class="line">                returnStatement.add(VMWriter.writePush(<span class="string">&quot;pointer&quot;</span>, <span class="number">0</span>));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (returnVal.equals(<span class="string">&quot;true&quot;</span>)) {</span><br><span class="line">                returnStatement.add(VMWriter.writePush(<span class="string">&quot;constant&quot;</span>, <span class="number">0</span>));</span><br><span class="line">                returnStatement.add(<span class="string">&quot;not&quot;</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (returnVal.equals(<span class="string">&quot;false&quot;</span>) || returnVal.equals(<span class="string">&quot;null&quot;</span>)) {</span><br><span class="line">                returnStatement.add(VMWriter.writePush(<span class="string">&quot;constant&quot;</span>, <span class="number">0</span>));</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (returnVal.matches(<span class="string">&quot;-?\\d+&quot;</span>)) {</span><br><span class="line">            <span class="comment">// Handle integer constants</span></span><br><span class="line">            returnStatement.add(VMWriter.writePush(<span class="string">&quot;constant&quot;</span>, Integer.parseInt(returnVal)));</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (returnVal.charAt(<span class="number">0</span>) == <span class="string">&apos;&quot;&apos;</span>) {</span><br><span class="line">            <span class="comment">// Handle string constants</span></span><br><span class="line">            returnVal = returnVal.substring(<span class="number">1</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> returnVal.substring(<span class="number">0</span>, returnVal.length() - <span class="number">1</span>);</span><br><span class="line">            returnStatement.addAll(VMWriter.writeString(string));</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Handle variable return values</span></span><br><span class="line">            returnStatement.add(VMWriter.writePush(SymbolTable.varKind(returnVal, curSubroutine.toString()), SymbolTable.varCount(returnVal, curSubroutine.toString())));</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// If no return value, push 0</span></span><br><span class="line">        returnStatement.add(VMWriter.writePush(<span class="string">&quot;constant&quot;</span>, <span class="number">0</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add return command</span></span><br><span class="line">    returnStatement.add(<span class="string">&quot;return&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> returnStatement;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4><span id="ddddo&#x8BED;&#x53E5;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">d.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">d</span><span class="mord">.</span></span></span></span><code>do</code>&#x8BED;&#x53E5;</span></h4>
<p>&#x2003;&#x2003;<code>do</code>&#x8BED;&#x53E5;&#x53EA;&#x9700;&#x5904;&#x7406;&#x88AB;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#x5373;&#x53EF;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title function_">compileDoStatement</span><span class="params">(String line)</span> {</span><br><span class="line">	line = line.substring(<span class="number">2</span>);</span><br><span class="line">&#xA0; &#xA0; <span class="keyword">return</span> compileSubroutineCall(line);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4><span id="eeelet&#x8BED;&#x53E5;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">e.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">e</span><span class="mord">.</span></span></span></span><code>let</code>&#x8BED;&#x53E5;</span></h4>
<p>&#x2003;&#x2003;&#x5BF9;<code>let</code>&#x8BED;&#x53E5;&#x7684;&#x5904;&#x7406;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x5206;&#x7C7B;&#x7684;&#x4F9D;&#x636E;&#xFF1A;<strong>&#x5DE6;&#x4FA7;&#x7684;&#x8868;&#x8FBE;&#x5F0F;&#x662F;&#x5426;&#x4E3A;&#x6570;&#x7EC4;</strong>&#xFF0C;&#x5982;&#x679C;&#x5DE6;&#x4FA7;&#x4E3A;&#x6570;&#x7EC4;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x52A0;&#x5165;&#x4EE5;&#x4E0B;&#x7684;&#x64CD;&#x4F5C;&#xFF1A;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pop temp 0</span><br><span class="line">pop pointer 1</span><br><span class="line">push temp 0</span><br><span class="line">pop that 0</span><br></pre></td></tr></table></figure>
<p>&#x2003;&#x2003;&#x5426;&#x5219;&#x5DE6;&#x4FA7;&#x8868;&#x8FBE;&#x5F0F;&#x53EA;&#x80FD;&#x662F;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x5176;<code>pop</code>&#x5373;&#x53EF;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#xA0; &#xA0; <span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title function_">compileLetStatement</span><span class="params">(String line)</span> {</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; ArrayList&lt;String&gt; letstatement = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; line = line.substring(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; <span class="type">String</span> <span class="variable">var1</span> <span class="operator">=</span> line.substring(<span class="number">0</span>, line.indexOf(<span class="string">&quot;=&quot;</span>));</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; <span class="type">String</span> <span class="variable">var2</span> <span class="operator">=</span> line.substring(line.indexOf(<span class="string">&quot;=&quot;</span>) + <span class="number">1</span>, line.indexOf(<span class="string">&quot;;&quot;</span>));</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; <span class="comment">//case 1: array var + expression</span></span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; <span class="keyword">if</span> (var1.contains(<span class="string">&quot;[&quot;</span>)) {</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span class="type">String</span> <span class="variable">exp1</span> <span class="operator">=</span> var1.substring(var1.indexOf(<span class="string">&quot;[&quot;</span>) + <span class="number">1</span>, var1.indexOf(<span class="string">&quot;]&quot;</span>));</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span class="type">String</span> <span class="variable">name1</span> <span class="operator">=</span> var1.substring(<span class="number">0</span>, var1.indexOf(<span class="string">&quot;[&quot;</span>));</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; ArrayList&lt;String&gt; expression1 = compileExpression(exp1);</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; letstatement.addAll(expression1);</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; letstatement.add(VMWriter.writePush(SymbolTable.varKind(name1, curSubroutine.toString()), SymbolTable.varCount(name1, curSubroutine.toString())));</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; letstatement.add(<span class="string">&quot;add&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; letstatement.addAll(compileExpression(var2));</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; letstatement.add(VMWriter.writePop(<span class="string">&quot;temp&quot;</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; letstatement.add(VMWriter.writePop(<span class="string">&quot;pointer&quot;</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; letstatement.add(VMWriter.writePush(<span class="string">&quot;temp&quot;</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; letstatement.add(VMWriter.writePop(<span class="string">&quot;that&quot;</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span class="keyword">return</span> letstatement;</span><br><span class="line"></span><br><span class="line">&#xA0; &#xA0; &#xA0; &#xA0; }</span><br></pre></td></tr></table></figure>
<h4><span id="eee&#x51FD;&#x6570;&#x4F53;&#x6A21;&#x5757;&#x8BBE;&#x8BA1;ampif-while&#x5904;&#x7406;&#x624B;&#x6BB5;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">e.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">e</span><span class="mord">.</span></span></span></span>&#x51FD;&#x6570;&#x4F53;&#x6A21;&#x5757;&#x8BBE;&#x8BA1;&amp;<code>if, while</code>&#x5904;&#x7406;&#x624B;&#x6BB5;</span></h4>
<p>&#x2003;&#x2003;&#x5728;&#x5904;&#x7406;<code>if</code>&#x8BED;&#x53E5;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5728;&#x5904;&#x7406;<code>if</code>&#x82B1;&#x62EC;&#x53F7;&#x62EC;&#x8D77;&#x7684;&#x90E8;&#x5206;&#x540E;&#x6DFB;&#x52A0;<code>IF_ENDLabelindex</code>&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x81EA;&#x7136;&#x5730;&#x60F3;&#x5230;&#x5F15;&#x5165;<code>compileSubroutineBody</code>&#x51FD;&#x6570;&#x5BF9;&#x51FD;&#x6570;&#x4F53;&#x6A21;&#x5757;&#x8FDB;&#x884C;&#x6574;&#x4F53;&#x5730;&#x7F16;&#x8BD1;(&#x800C;&#x975E;&#x4E00;&#x6761;&#x8BED;&#x53E5;&#x4E00;&#x6761;&#x8BED;&#x53E5;&#x5730;&#x79BB;&#x6563;&#x5904;&#x7406;)&#xFF0C;&#x5B83;&#x63A5;&#x53D7;&#x7684;&#x53C2;&#x6570;&#x662F;<strong>&#x591A;&#x6761;&#x8BED;&#x53E5;&#x6784;&#x6210;&#x7684;&#x51FD;&#x6570;&#x4F53;<code>ArrayList&lt;String&gt;</code></strong>&#x3002;</p>
<p>&#x2003;&#x2003;&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x5B9E;&#x73B0;<code>if</code>&#x8BED;&#x53E5;&#x5462;&#xFF1F;&#x4E00;&#x4E2A;&#x81EA;&#x7136;&#x5730;&#x60F3;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x8BBE;&#x8BA1;&#x4E00;&#x4E2A;&#x51FD;&#x6570;<code>compileIfStatement()</code>&#xFF0C;&#x5B83;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;<code>ArrayList&lt;String&gt;</code>&#xFF0C;&#x8FD4;&#x56DE;&#x7F16;&#x8BD1;&#x540E;&#x7684;<code>ArrayList&lt;String&gt;</code>&#x3002;</li>
<li>&#x4F20;&#x5165;<code>if</code>&#x8BED;&#x53E5;&#x5BF9;&#x5E94;&#x7684;&#x5B50;&#x7A0B;&#x5E8F;&#xFF0C;&#x7136;&#x540E;&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#x3002;</li>
</ol>
<p>&#x2003;&#x2003;&#x4F46;&#x662F;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x5F97;&#x5230;&#x8F93;&#x51FA;&#x7ED3;&#x679C;&#x5E76;&#x5F80;&#x4E0B;&#x7EE7;&#x7EED;&#x5904;&#x7406;&#x65F6;&#xFF0C;&#x90A3;&#x4E9B;&#x5C5E;&#x4E8E;<code>if</code>&#x5B50;&#x7A0B;&#x5E8F;&#x7684;&#x4EE3;&#x7801;&#x4F1A;<strong>&#x88AB;&#x91CD;&#x590D;&#x5904;&#x7406;</strong>&#x3002;&#x8FD9;&#x5E76;&#x4E0D;&#x662F;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x7684;&#x7ED3;&#x679C;&#x3002;&#x7B14;&#x8005;&#x66FE;&#x8BD5;&#x8FC7;&#x5904;&#x7406;&#x5B8C;<code>if</code>&#x7684;&#x5B50;&#x7A0B;&#x5E8F;&#x540E;&#x5C06;&#x5176;&#x5220;&#x53BB;&#xFF0C;&#x4F46;&#x6700;&#x7EC8;&#x5931;&#x8D25;&#x4E86;&#x3002;&#x56E0;&#x6B64;&#x7B14;&#x8005;&#x60F3;&#x5230;&#x4E86;&#x4E0B;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li>&#x6211;&#x4EEC;&#x4F9D;&#x7136;&#x5BF9;<code>if</code>&#x5BF9;&#x5E94;&#x7684;&#x5B50;&#x7A0B;&#x5E8F;&#x8FDB;&#x884C;&#x8BFB;&#x53D6;&#x3002;</li>
<li>&#x4F46;&#x6211;&#x4EEC;&#x5E76;&#x4E0D;&#x5C06;&#x5176;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x5165;<code>compileIfStatement</code>&#xFF0C;&#x800C;&#x662F;<strong>&#x8BB0;&#x5F55;&#x4E0B;&#x8BE5;&#x5B50;&#x7A0B;&#x5E8F;&#x7684;&#x884C;&#x6570;</strong><code>ifIndex</code>&#x3002;</li>
<li>&#x540C;&#x65F6;&#xFF0C;&#x5728;<code>compileSubroutineBody</code>&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5B9E;&#x65F6;&#x66F4;&#x65B0;&#x5F53;&#x524D;&#x7684;&#x4EE3;&#x7801;&#x884C;&#x6570;<code>currentIndex</code>&#x3002;</li>
<li>&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x8BB0;&#x5F55;&#x7684;<code>currentIndex</code>&#x548C;<code>ifIndex</code><strong>&#x8BA1;&#x7B97;&#x51FA;&#x5E94;&#x8BE5;&#x6DFB;&#x52A0;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>a</mi><mi>b</mi><mi>e</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">label</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span>&#x7684;&#x884C;&#x6570;</strong>&#xFF0C;&#x7136;&#x540E;<strong>&#x5F53;<code>currentIndex</code>&#x7684;&#x503C;&#x4E0E;&#x5176;&#x76F8;&#x7B49;&#x65F6;&#x6DFB;&#x52A0;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>a</mi><mi>b</mi><mi>e</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">label</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span></strong>&#x3002;</li>
</ol>
<p>&#x2003;&#x2003;&#x540C;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x4F9D;&#x7136;&#x4FDD;&#x7559;<code>compileIfStatement</code>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x53EA;&#x662F;&#x8BE5;&#x65B9;&#x6CD5;&#x4EC5;&#x7528;&#x6765;&#x7F16;&#x8BD1;<code>if(expression)</code>&#x8BED;&#x53E5;&#x3002;</p>
<blockquote>
<p>&#x5982;&#x679C;&#x9047;&#x5230;<code>else</code>&#x8BED;&#x53E5;&#xFF0C;&#x76F4;&#x63A5;&#x5FFD;&#x7565;&#x5373;&#x53EF;&#x3002;</p>
</blockquote>
<blockquote>
<p>&#x53E6;&#xFF1A;&#x6211;&#x4EEC;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x7528;&#x7C7B;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;<code>static int ifLabelCount</code>&#x4F5C;&#x4E3A;&#x6807;&#x8BB0;&#x7684;&#x5E8F;&#x53F7;&#xFF0C;&#x56E0;&#x4E3A;&#x5F53;&#x5B58;&#x5728;&#x5D4C;&#x5957;&#x6761;&#x4EF6;&#x5FAA;&#x73AF;&#x65F6;&#xFF0C;&#x7531;&#x4E8E;&#x4E0D;&#x7BA1;&#x9047;&#x5230;&#x54EA;&#x4E2A;<code>if</code>&#x8BE5;&#x503C;&#x90FD;&#x4F1A;&#x589E;&#x52A0;1&#xFF0C;&#x8FD9;&#x4F1A;&#x5BFC;&#x81F4;<strong>&#x540C;&#x4E00;&#x4E2A;<code>if</code>&#x7684;&#x524D;&#x540E;&#x6807;&#x8BB0;&#x5E8F;&#x53F7;&#x4E0D;&#x4E00;&#x81F4;</strong>&#x3002;&#x5BF9;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;<strong>&#x7528;&#x4E00;&#x4E2A;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>a</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">Map</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span></span></span></span>&#x6765;&#x5B58;&#x50A8;&#x7279;&#x5B9A;<code>lineIndex</code>&#x5BF9;&#x5E94;&#x7684;&#x6807;&#x8BB0;&#x5E8F;&#x53F7;</strong>&#xFF0C;&#x7531;&#x4E8E;<code>lineIndex</code>&#x662F;&#x552F;&#x4E00;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x524D;&#x540E;&#x6807;&#x8BB0;&#x5E8F;&#x53F7;&#x5C06;&#x4F1A;&#x4E00;&#x81F4;&#x3002;</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title function_">compileSubroutineBody</span><span class="params">(ArrayList&lt;String&gt; lines)</span> {</span><br><span class="line">    ArrayList&lt;String&gt; subroutinebody = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span> <span class="variable">lineIndex</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ifstatementLineNum</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">whilestatementLineNum</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String line : lines) {</span><br><span class="line">        <span class="keyword">if</span> (lineIndex == ifstatementLineNum) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">labelCnt</span> <span class="operator">=</span> loopCount.get(ifstatementLineNum);</span><br><span class="line">            subroutinebody.add(<span class="string">&quot;label IF_FALSE&quot;</span> + Integer.toString(labelCnt));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (lineIndex == whilestatementLineNum) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">labelCnt</span> <span class="operator">=</span> loopCount.get(whilestatementLineNum);</span><br><span class="line">            subroutinebody.add(<span class="string">&quot;goto WHILE_EXP&quot;</span> + Integer.toString(labelCnt));</span><br><span class="line">            subroutinebody.add(<span class="string">&quot;label WHILE_END&quot;</span> + Integer.toString(labelCnt));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (line.indexOf(<span class="string">&quot;else&quot;</span>) == <span class="number">0</span>) {</span><br><span class="line">            line = line.substring(<span class="number">4</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (line.indexOf(<span class="string">&quot;do&quot;</span>) == <span class="number">0</span>) {</span><br><span class="line">            subroutinebody.addAll(compileDoStatement(line));</span><br><span class="line">            lineIndex++;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (line.indexOf(<span class="string">&quot;let&quot;</span>) == <span class="number">0</span>) {</span><br><span class="line">            subroutinebody.addAll(compileLetStatement(line));</span><br><span class="line">            lineIndex++;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (line.indexOf(<span class="string">&quot;return&quot;</span>) == <span class="number">0</span>) {</span><br><span class="line">            subroutinebody.addAll(compileReturnStatement(line));</span><br><span class="line">            lineIndex++;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (line.indexOf(<span class="string">&quot;if&quot;</span>) == <span class="number">0</span>) {</span><br><span class="line">            <span class="type">String</span> <span class="variable">ifstatement</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;{&quot;</span>)) {</span><br><span class="line">                ifstatement = line.substring(<span class="number">0</span>, line.indexOf(<span class="string">&quot;{&quot;</span>));</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                ifstatement = line;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            subroutinebody.addAll(compileIfStatement(ifstatement));</span><br><span class="line">            subroutinebody.add(<span class="string">&quot;if-goto IF_TRUE&quot;</span> + Integer.toString(ifLabelCount));</span><br><span class="line">            subroutinebody.add(<span class="string">&quot;goto IF_FALSE&quot;</span> + Integer.toString(ifLabelCount));</span><br><span class="line">            subroutinebody.add(<span class="string">&quot;label IF_TRUE&quot;</span> + Integer.toString(ifLabelCount));</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;{&quot;</span>) &amp;&amp; line.indexOf(<span class="string">&quot;{&quot;</span>) != line.length() - <span class="number">1</span>) {</span><br><span class="line">                ArrayList&lt;String&gt; statement = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                statement.add(line.substring(line.indexOf(<span class="string">&quot;{&quot;</span>) + <span class="number">1</span>));</span><br><span class="line">                subroutinebody.addAll(compileSubroutineBody(statement));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            ifstatementLineNum = Operation.selectContent(Operation.subList(lines, lineIndex)).size() + lineIndex++;</span><br><span class="line">            loopCount.put(ifstatementLineNum, ifLabelCount++);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (line.indexOf(<span class="string">&quot;while&quot;</span>) == <span class="number">0</span>) {</span><br><span class="line">            <span class="type">String</span> <span class="variable">whilestatement</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;{&quot;</span>)) {</span><br><span class="line">                whilestatement = line.substring(<span class="number">0</span>, line.indexOf(<span class="string">&quot;{&quot;</span>));</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                whilestatement = line;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            subroutinebody.add(<span class="string">&quot;label WHILE_EXP&quot;</span> + Integer.toString(whileLabelCount));</span><br><span class="line">            subroutinebody.addAll(compileWhileStatement(whilestatement));</span><br><span class="line">            subroutinebody.add(<span class="string">&quot;not&quot;</span>);</span><br><span class="line">            subroutinebody.add(<span class="string">&quot;if-goto WHILE_END&quot;</span> + Integer.toString(whileLabelCount));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (line.contains(<span class="string">&quot;{&quot;</span>) &amp;&amp; line.indexOf(<span class="string">&quot;{&quot;</span>) != line.length() - <span class="number">1</span>) {</span><br><span class="line">                ArrayList&lt;String&gt; statement = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                statement.add(line.substring(line.indexOf(<span class="string">&quot;{&quot;</span>) + <span class="number">1</span>));</span><br><span class="line">                subroutinebody.addAll(compileSubroutineBody(statement));</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            whilestatementLineNum = Operation.selectContent(Operation.subList(lines, lineIndex)).size() + lineIndex++;</span><br><span class="line">            loopCount.put(whilestatementLineNum, whileLabelCount++);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            lineIndex++;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> subroutinebody;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4><span id="fff&#x5176;&#x4ED6;&#x6742;&#x9879;&#x7684;&#x5904;&#x7406;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">f.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord">.</span></span></span></span>&#x5176;&#x4ED6;&#x6742;&#x9879;&#x7684;&#x5904;&#x7406;</span></h4>
<p>&#x2003;&#x2003;&#x5728;&#x5B9E;&#x73B0;&#x4E86;&#x6846;&#x67B6;&#x7684;&#x5927;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x540E;&#xFF0C;&#x9488;&#x5BF9;VM&#x4EE3;&#x7801;&#x81EA;&#x8EAB;&#x7684;&#x7279;&#x5B9A;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x989D;&#x5916;&#x8865;&#x5145;&#x5BF9;&#x4E00;&#x4E9B;&#x64CD;&#x4F5C;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;</p>
<ol>
<li>&#x5BF9;&#x6570;&#x7EC4;&#x7684;&#x5904;&#x7406;&#xFF1A;&#x6211;&#x4EEC;&#x5C06;&#x6570;&#x7EC4;&#x540D;&#x79F0;&#x6240;&#x5728;&#x5185;&#x5B58;&#x6BB5;&#x548C;&#x5185;&#x90E8;&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x503C;<code>add</code>&#xFF0C;&#x7136;&#x540E;<code>pop pointer 1</code>&#xFF0C;<code>push that 0</code>&#x5373;&#x53EF;&#xFF1A;</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title function_">compileArray</span><span class="params">(String line)</span> {</span><br><span class="line">    ArrayList&lt;String&gt; array = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// the array consists of varName + [ + expression + ]</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">varName</span> <span class="operator">=</span> line.substring(<span class="number">0</span>, line.indexOf(<span class="string">&quot;[&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> line.substring(line.indexOf(<span class="string">&quot;[&quot;</span>) + <span class="number">1</span>, line.indexOf(<span class="string">&quot;]&quot;</span>));</span><br><span class="line">    ArrayList&lt;String&gt; expression = compileExpression(exp);</span><br><span class="line"></span><br><span class="line">    array.add(VMWriter.writePush(SymbolTable.varKind(varName, curSubroutine.toString()), SymbolTable.varCount(varName, curSubroutine.toString())));</span><br><span class="line">    array.addAll(expression);</span><br><span class="line">    array.add(<span class="string">&quot;add&quot;</span>);</span><br><span class="line">    array.add(VMWriter.writePop(<span class="string">&quot;pointer&quot;</span>, <span class="number">1</span>));</span><br><span class="line">    array.add(VMWriter.writePush(<span class="string">&quot;that&quot;</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>&#x8C03;&#x7528;&#x51FD;&#x6570;&#xFF1A;&#x5C06;&#x51FD;&#x6570;&#x6240;&#x9700;&#x53C2;&#x6570;<code>push</code>&#xFF0C;&#x7136;&#x540E;&#x8BA1;&#x7B97;&#x53C2;&#x6570;&#x4E2A;&#x6570;&#x3001;&#x8C03;&#x7528;&#x5373;&#x53EF;&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x5224;&#x65AD;&#x51FD;&#x6570;&#x662F;&#x5426;&#x4E3A;<code>void</code>&#x578B;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x7684;&#x8BDD;&#x9700;&#x8981;<code>pop temp 0</code>&#xFF1A;</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; <span class="title function_">compileSubroutineCall</span><span class="params">(String line)</span> {</span><br><span class="line">    ArrayList&lt;String&gt; subroutine = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span> <span class="variable">argNum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we first store the functionName</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">funcName</span> <span class="operator">=</span> line.substring(<span class="number">0</span>, line.indexOf(<span class="string">&quot;(&quot;</span>));</span><br><span class="line">    line = line.substring(line.indexOf(<span class="string">&quot;(&quot;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!funcName.contains(<span class="string">&quot;.&quot;</span>)) funcName = className + <span class="string">&quot;.&quot;</span> + funcName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// then comes the expressionList</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">expressionList</span> <span class="operator">=</span> line.substring(line.indexOf(<span class="string">&apos;(&apos;</span>) + <span class="number">1</span>, line.indexOf(<span class="string">&apos;)&apos;</span>));</span><br><span class="line">    <span class="keyword">if</span> (!expressionList.isEmpty()) {</span><br><span class="line">        ArrayList&lt;String&gt; expressions = compileExpressionList(expressionList);</span><br><span class="line">        subroutine.addAll(expressions);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!expressionList.isEmpty()) {</span><br><span class="line">        argNum = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; expressionList.length(); i++) {</span><br><span class="line">            <span class="keyword">if</span> (expressionList.charAt(i) == <span class="string">&apos;,&apos;</span>) argNum++;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// finally we call the method</span></span><br><span class="line">    <span class="keyword">if</span> (Tokenizer.funcCollection.contains(funcName)) {</span><br><span class="line">        subroutine.add(VMWriter.writeFunctionCall(funcName, argNum));</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">for</span> (String s : Tokenizer.funcCollection) {</span><br><span class="line">            <span class="keyword">if</span> (s.substring(s.indexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>).equals(funcName.substring(funcName.indexOf(<span class="string">&quot;.&quot;</span>) + <span class="number">1</span>))) {</span><br><span class="line">                subroutine.add(VMWriter.writeFunctionCall(s, argNum));</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (funcType.get(funcName).equals(<span class="string">&quot;void&quot;</span>))</span><br><span class="line">        subroutine.add(VMWriter.writePop(<span class="string">&quot;temp&quot;</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> subroutine;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4><span id="ggg-compileengine&#x6700;&#x7EC8;&#x6784;&#x5EFA;"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">g.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord">.</span></span></span></span> <code>CompileEngine</code>&#x6700;&#x7EC8;&#x6784;&#x5EFA;</span></h4>
<ol>
<li>
<p>&#x9884;&#x5904;&#x7406;&#x3002;&#x5C06;&#x5F85;&#x7F16;&#x8BD1;&#x7684;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x6587;&#x4EF6;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x4F20;&#x5165;<code>SymbolTable.constructor</code>&#xFF0C;&#x4EE5;&#x6784;&#x5EFA;&#x6BCF;&#x4E2A;&#x6587;&#x4EF6;&#x5BF9;&#x5E94;&#x7684;<code>Symbol Table</code>&#x3002;</p>
</li>
<li>
<p>&#x7F16;&#x8BD1;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x9047;&#x5230;&#x4E00;&#x4E2A;&#x51FD;&#x6570;/&#x65B9;&#x6CD5;&#x540D;&#xFF0C;&#x5148;&#x5C06;&#x5176;&#x5B58;&#x5165;<code>funcType</code>&#x4E2D;&#xFF0C;&#x4EE5;&#x5728;&#x540E;&#x7EED;&#x8C03;&#x7528;&#x8BE5;&#x51FD;&#x6570;&#x65F6;&#x80FD;&#x591F;&#x627E;&#x5230;&#x8BE5;&#x51FD;&#x6570;/&#x65B9;&#x6CD5;&#x540D;&#x3002;</p>
</li>
<li>
<p>&#x5BF9;<code>constructor</code>&#xFF0C;<code>method</code>&#x9700;&#x8981;&#x8FDB;&#x884C;&#x5404;&#x81EA;&#x7684;&#x9884;&#x5904;&#x7406;&#x3002;</p>
</li>
<li>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x5F85;&#x7F16;&#x8BD1;&#x7684;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#x5206;&#x7C7B;&#xFF1A;</p>
<ul>
<li>&#x65B9;&#x6CD5;/&#x51FD;&#x6570;&#x7684;&#x58F0;&#x660E;&#x3002;</li>
<li>&#x53D8;&#x91CF;&#x58F0;&#x660E;&#x3002;</li>
<li>&#x65B9;&#x6CD5;/&#x51FD;&#x6570;&#x4F53;&#x3002;</li>
</ul>
</li>
</ol>
<p>&#x2003;&#x2003;&#x5BF9;&#x6BCF;&#x4E00;&#x7C7B;&#xFF0C;&#x5206;&#x522B;&#x7F16;&#x8BD1;&#x5373;&#x53EF;&#x3002;&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF0C;&#x5904;&#x7406;&#x51FD;&#x6570;&#x4F53;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8BFB;&#x5165;&#x6574;&#x4E2A;&#x5B50;&#x7A0B;&#x5E8F;&#xFF0C;&#x5C06;&#x5176;&#x653E;&#x5165;<code>ArrayList&lt;String&gt;</code>&#x4E2D;&#x4F5C;&#x4E3A;<code>compileSubroutineBody</code>&#x7684;&#x53C2;&#x6570;&#xFF1A;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">constructor</span><span class="params">(String[] files)</span> {</span><br><span class="line">    <span class="keyword">for</span> (String filename : files) {</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> filename.substring(<span class="number">0</span>, filename.length() - <span class="number">5</span>);</span><br><span class="line">        Operation.addToArray(Tokenizer.className, name);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    initType();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String filename : files) {</span><br><span class="line">        SymbolTable.constructor(filename);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">String</span> <span class="variable">vmFile</span> <span class="operator">=</span> filename.substring(<span class="number">0</span>, filename.length() - <span class="number">5</span>) + <span class="string">&quot;.vm&quot;</span>;</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(filename));</span><br><span class="line">            <span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(vmFile));</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> Operation.modify(reader.readLine());</span><br><span class="line">            <span class="keyword">while</span> (line != <span class="literal">null</span>) {</span><br><span class="line">                <span class="keyword">if</span> (!line.isEmpty()) {</span><br><span class="line">                    <span class="keyword">if</span> (line.indexOf(<span class="string">&quot;class&quot;</span>) == <span class="number">0</span>) {</span><br><span class="line">                        className.setLength(<span class="number">0</span>);</span><br><span class="line">                        className.append(line.substring(<span class="number">5</span>, line.length() - <span class="number">1</span>));</span><br><span class="line">                        line = Operation.modify(reader.readLine());</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (isSubroutineDec(line)) {</span><br><span class="line">                        <span class="type">String</span> <span class="variable">subroutineKind</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">subroutineType</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">subroutineLength</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">typeLength</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; subroutineDec.length; i++) {</span><br><span class="line">                            <span class="keyword">if</span> (line.indexOf(subroutineDec[i]) == <span class="number">0</span>) {</span><br><span class="line">                                subroutineKind = subroutineDec[i];</span><br><span class="line">                                subroutineLength = subroutineDec[i].length();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        line = line.substring(subroutineLength);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// then comes the type</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; type.length; i++) {</span><br><span class="line">                            <span class="keyword">if</span> (line.indexOf(type[i]) == <span class="number">0</span>) {</span><br><span class="line">                                subroutineType = type[i];</span><br><span class="line">                                typeLength = type[i].length();</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        line = line.substring(typeLength);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">subroutine</span> <span class="operator">=</span> className + <span class="string">&quot;.&quot;</span> + line.substring(<span class="number">0</span>, line.indexOf(<span class="string">&quot;(&quot;</span>));</span><br><span class="line">                        curSubroutine.setLength(<span class="number">0</span>);</span><br><span class="line">                        curSubroutine.append(subroutine);</span><br><span class="line">                        funcType.put(curSubroutine.toString(), subroutineType);</span><br><span class="line">                        writer.write(VMWriter.writeFunctionDec(curSubroutine.toString(), SymbolTable.kindCount(<span class="string">&quot;local&quot;</span>, curSubroutine.toString())));</span><br><span class="line">                        writer.newLine();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (subroutineKind.equals(<span class="string">&quot;constructor&quot;</span>)) {</span><br><span class="line">                            <span class="type">String</span> <span class="variable">line1</span> <span class="operator">=</span> VMWriter.writePush(<span class="string">&quot;constant&quot;</span>, SymbolTable.kindCount(<span class="string">&quot;field&quot;</span>, <span class="literal">null</span>));</span><br><span class="line">                            <span class="type">String</span> <span class="variable">line2</span> <span class="operator">=</span> VMWriter.writeCall(<span class="string">&quot;Memory.alloc&quot;</span>, <span class="number">1</span>);</span><br><span class="line">                            writer.write(line1);</span><br><span class="line">                            writer.newLine();</span><br><span class="line">                            writer.write(line2);</span><br><span class="line">                            writer.newLine();</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (subroutineKind.equals(<span class="string">&quot;method&quot;</span>)) {</span><br><span class="line">                            <span class="type">String</span> <span class="variable">line1</span> <span class="operator">=</span> VMWriter.writePush(<span class="string">&quot;argument&quot;</span>, <span class="number">0</span>);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">line2</span> <span class="operator">=</span> VMWriter.writePop(<span class="string">&quot;pointer&quot;</span>, <span class="number">0</span>);</span><br><span class="line">                            writer.write(line1);</span><br><span class="line">                            writer.newLine();</span><br><span class="line">                            writer.write(line2);</span><br><span class="line">                            writer.newLine();</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        line = Operation.modify(reader.readLine());</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// case 2: varDec, we just ignore it</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (isVarDec(line)) {</span><br><span class="line">                        <span class="keyword">while</span> (isVarDec(line)) {</span><br><span class="line">                            line = Operation.modify(reader.readLine());</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// case 3: subroutineBody</span></span><br><span class="line">                    <span class="keyword">else</span> {</span><br><span class="line">                        ArrayList&lt;String&gt; subroutineCode = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">                        <span class="keyword">while</span> (line != <span class="literal">null</span> &amp;&amp; !isSubroutineDec(line)) {</span><br><span class="line">                            <span class="keyword">if</span> (!line.isEmpty()) {</span><br><span class="line">                                System.out.println(line);</span><br><span class="line">                                subroutineCode.add(line);</span><br><span class="line">                            }</span><br><span class="line">                            line = Operation.modify(reader.readLine());</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        ArrayList&lt;String&gt; subroutineBody = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(compileSubroutineBody(subroutineCode));</span><br><span class="line">                        <span class="keyword">for</span> (String s : subroutineBody) {</span><br><span class="line">                            writer.write(s);</span><br><span class="line">                            writer.newLine();</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        line = Operation.modify(reader.readLine());</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                line = Operation.modify(reader.readLine());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            reader.close();</span><br><span class="line">            writer.close();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">10.8.&#x5BF9;&#x6570;&#x7EC4;&#x7684;&#x5904;&#x7406;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-27 20:15:43" itemprop="dateCreated datePublished" datetime="2024-04-27T20:15:43+08:00">2024-04-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 16:04:46" itemprop="dateModified" datetime="2024-06-03T16:04:46+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-10-Code-Generator/" itemprop="url" rel="index"><span itemprop="name">Module 10.Code Generator</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>521</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>2 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="108108108handling-array"> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10.8.</mn></mrow><annotation encoding="application/x-tex">10.8.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">.</span></span></span></span>Handling Array</span></h1>
<h3><span id="1array-construction"> 1.Array construction</span></h3>
<p>&#x2003;&#x2003;Assume that the high-level programmer writes <code>var Array arr</code>.</p>
<ul>
<li>In response to this, the compiler will only <strong>allocate a <code>local</code> variable</strong> to represent the array and <strong>initialize this variable to 0</strong>.</li>
<li>This statement <strong>generates no code</strong>. The compiler will <strong>get a variable called <code>loca1 0</code>, its type <code>Array</code> and name <code>arr</code></strong>.</li>
</ul>
<p>&#x2003;&#x2003;When we construct this array by calling the subroutine of the <code>Array</code> class: <code>let arr = Array.new(5)</code>.</p>
<ul>
<li>The compiler and OS will magically <strong>allocate sufficient space in the heap</strong> to represent the array.</li>
<li>The base address of the new allocated block is going to be stored in <code>local 0</code>, regardless of the address may be.</li>
<li>What we have here is <strong>a standard call to a Jack subroutine</strong>, which we already knew how to handle.</li>
</ul>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image.png" alt></p>
<h3><span id="2array-manipulation"> 2.Array manipulation</span></h3>
<h4><span id="aaathis-and-that-review"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">a.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">a</span><span class="mord">.</span></span></span></span><code>THIS</code> and <code>THAT</code> review</span></h4>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-1.png" alt></p>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-2.png" alt></p>
<h5><span id="bbbgenerating-code"> &#x2003;&#x2003;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">b.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">b</span><span class="mord">.</span></span></span></span>Generating code</span></h5>
<p>&#x2003;&#x2003;Suppose we want to conduct <code>arr[2] = 17</code>:</p>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-3.png" alt></p>
<ul>
<li>
<p>Since the base address of <code>arr</code> is stored in <code>THAT</code>, we simply <code>push arr</code> then <code>push index</code>, and <code>add</code> to get <code>arr + 2</code>.</p>
</li>
<li>
<p>Then the <code>THAT</code> pointer will be aligned with the address we want to manipulate.</p>
</li>
<li>
<p>Notice that:</p>
<ol>
<li>We use <strong>only <code>THAT 0</code></strong>, we don&#x2019;t use other entries from <code>THAT</code> segment.</li>
<li>The VM code you have <strong>operates in a completely symbolic logical world</strong>. It doesn&#x2019;t know where the array is located in RAM or which address we are manipulating. In this respect, it&#x2019;s a very safe code, for it cannot reach out of the VM world, because all the physical considerations are being implemented by the VM translator, and VM code itself is completely oblivious of the host platform. This is very important because we have numerous different computers, we don&#x2019;t know where this code is going to run, and we <strong>don&#x2019;t have the luxury of making any assumptions about the underlying hardware platform</strong>.</li>
</ol>
</li>
</ul>
<p>&#x2003;&#x2003;What about <code>arr[exp1] = exp2</code>? As above, we may write the following code:</p>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-4.png" alt></p>
<p>&#x2003;&#x2003;This seems make sense, but when we try to write <code>a[i] = b[j]</code>, there comes a crush:</p>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-5.png" alt></p>
<p>&#x2003;&#x2003;To avoid this, we:</p>
<ol>
<li>First deal with the right hand side and left hand side separately. Once we complete this, the stack is going to <strong>contain two addresses</strong>: the address of <code>a[i]</code> and the address of <code>b[j]</code>:</li>
</ol>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-6.png" alt></p>
<ol start="2">
<li>We <strong><code>pop</code> the topmost value</strong> onto <code>pointer 1</code>, which is <code>b[i]</code> in this example. Once is done, we are going to get the following state:</li>
</ol>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-7.png" alt></p>
<ol start="3">
<li>Now that <code>That 0</code> is aligned with <code>b[j]</code>, we <strong><code>push</code> the value in <code>b[j]</code> and <code>pop</code> it into <code>temp 0</code></strong>. This is the picture of the VM segments after the process:</li>
</ol>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-8.png" alt></p>
<ol start="4">
<li>Because we have <strong>safely saved the value of <code>b[i]</code></strong>, we can <strong>take the address of <code>a[i]</code> and <code>pop</code> it onto <code>pointer 1</code></strong></li>
<li>We finally <strong><code>push temp 0</code> onto the stack</strong> and <strong><code>pop</code> it onto <code>that 0</code></strong>, which is on the address of <code>a[i]</code>:</li>
</ol>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-9.png" alt></p>
<p>&#x2003;&#x2003;The general solution for generating array access code is as below:</p>
<p>![[Pasted image 20240507234141.png]]</p>
<p><img src="/2024/04/27/10-8-%E5%AF%B9%E6%95%B0%E7%BB%84%E7%9A%84%E5%A4%84%E7%90%86/image-10.png" alt></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/26/10-7-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%93%8D%E7%BA%B5%E5%AF%B9%E8%B1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/26/10-7-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%93%8D%E7%BA%B5%E5%AF%B9%E8%B1%A1/" class="post-title-link" itemprop="url">10.7.&#x5BF9;&#x5BF9;&#x8C61;&#x7684;&#x5904;&#x7406;&#x2014;&#x2014;&#x64CD;&#x7EB5;&#x5BF9;&#x8C61;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-26 20:15:43" itemprop="dateCreated datePublished" datetime="2024-04-26T20:15:43+08:00">2024-04-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 15:58:26" itemprop="dateModified" datetime="2024-06-03T15:58:26+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-10-Code-Generator/" itemprop="url" rel="index"><span itemprop="name">Module 10.Code Generator</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>489</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>2 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="107107107handling-objects-manipulation"> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10.7.</mn></mrow><annotation encoding="application/x-tex">10.7.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">7</span><span class="mord">.</span></span></span></span>Handling Objects: Manipulation</span></h1>
<h3><span id="1compiling-method-calls"> 1.Compiling method calls</span></h3>
<ul>
<li>In compiler, we are going to translate the OO method calls into <strong>procedural style language</strong> like VM language or machine language, they don&#x2019;t understand what an object is.</li>
</ul>
<p>&#x2003;&#x2003;In order to do this:</p>
<ul>
<li>We can <strong>treat the object as the first, implicit argument</strong>. We push it onto the stack, because we want it to <strong>be the first argument on which the method is going to operate</strong>.</li>
</ul>
<p><img src="/2024/04/26/10-7-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%93%8D%E7%BA%B5%E5%AF%B9%E8%B1%A1/image-5.png" alt></p>
<ol>
<li>We <code>push</code> the object into the stack.</li>
<li>We <code>push</code> enough arguments into the stack.</li>
<li>We <code>call</code> the method.</li>
</ol>
<p>&#x2003;&#x2003;When we say &#x201C;put the object onto the stack&#x201D;, we don&#x2019;t care what the object is, we are only interested in its <em>base address</em>.</p>
<h3><span id="2compiling-methods"> 2.Compiling methods</span></h3>
<p>&#x2003;&#x2003;Methods are used to operate on the object which refers to as <code>THIS</code>. Therefore, each method&#x2019;s code needs to <strong>access to the object&#x2019;s <code>field</code> variables</strong>.</p>
<p>&#x2003;&#x2003;In the previous unit, we know that we can access the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>t</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">ith</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></span></span></span> <code>field</code> by <code>THIS i</code>. However, before we use <code>THIS</code>, we have to anchor it on the proper address on the RAM first, so we also need <code>pointer</code>.</p>
<p><img src="/2024/04/26/10-7-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%93%8D%E7%BA%B5%E5%AF%B9%E8%B1%A1/image-6.png" alt></p>
<p>&#x2003;&#x2003;Let&#x2019;s take the <code>distance</code> method as an example:</p>
<ol>
<li>The method is compiled within a class, so we will <strong>compile the class variables</strong>, namely <code>x, y, pointCount</code>. This will end up generating no code.</li>
<li>Both the method declaration and variable declaration generate no code, either. Instead, the compiler <strong>creates the symbol table of the subroutine</strong> and <strong>populates it within the <code>this</code> object as well as the explicit variables that is found in the parameter list and the variable declaration.</strong></li>
<li>We can anticipate that the method will want to operate on the current object, so we need to generate code that will <strong>anchor this on the correct address in memory</strong>. And we know that the current object address is <code>argument 0</code>, so we do <code>push argument 0</code> and <code>pop pointer 0</code> to let <code>THIS</code> pointer to contain the address of the current object.</li>
</ol>
<p>&#x2003;&#x2003;When the <code>distance</code> method completes execution and terminates, control will return to the caller. The compiled code of the caller is as below:</p>
<p><img src="/2024/04/26/10-7-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%93%8D%E7%BA%B5%E5%AF%B9%E8%B1%A1/image-7.png" alt></p>
<ul>
<li>We know that the method returns a value on the top of stack, so we remove it and put it into <code>d</code>.</li>
</ul>
<h3><span id="3void-method-compilation"> 3.<code>void</code> method compilation</span></h3>
<p><img src="/2024/04/26/10-7-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%93%8D%E7%BA%B5%E5%AF%B9%E8%B1%A1/image-8.png" alt></p>
<p>&#x2003;&#x2003;The <code>void</code> doesn&#x2019;t expect to get a return value, while according to the rules of the game, we must return a value. As a result, we:</p>
<ol>
<li>To obey the rule, we <strong>generate code at the end of each method that returns a value</strong>.</li>
<li>Since we have nothing to return, we <code>push constant 0</code>, which is a dummy value and then <code>return</code>.</li>
</ol>
<p>&#x2003;&#x2003;But now the compiled code faces a slight problem: the stack contains uncessary value and we want to get rid of it.</p>
<ol start="3">
<li>To do this, we simply <code>pop temp 0</code>.</li>
</ol>
<p><img src="/2024/04/26/10-7-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%93%8D%E7%BA%B5%E5%AF%B9%E8%B1%A1/image-9.png" alt></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/25/10-6-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%9E%84%E9%80%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/25/10-6-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%9E%84%E9%80%A0/" class="post-title-link" itemprop="url">10.6.&#x5BF9;&#x5BF9;&#x8C61;&#x7684;&#x5904;&#x7406;&#x2014;&#x2014;&#x6784;&#x9020;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-25 20:15:43" itemprop="dateCreated datePublished" datetime="2024-04-25T20:15:43+08:00">2024-04-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 15:56:21" itemprop="dateModified" datetime="2024-06-03T15:56:21+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-10-Code-Generator/" itemprop="url" rel="index"><span itemprop="name">Module 10.Code Generator</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>664</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>2 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="106106106handling-objects-construction"> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10.6.</mn></mrow><annotation encoding="application/x-tex">10.6.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">6</span><span class="mord">.</span></span></span></span>Handling Objects: Construction</span></h1>
<p><img src="/2024/04/25/10-6-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%9E%84%E9%80%A0/image.png" alt></p>
<ul>
<li>What we have here is two completely separate compilation units. We are facing the challenge of compiling the caller class and the callee class.</li>
</ul>
<h3><span id="1high-level-of-object-construction"> 1.High level of object construction</span></h3>
<ul>
<li>When we do <code>var Point p1</code>, the compiler will end up generating code on <strong>some location in the stack which is going to be initialized to 0</strong>.</li>
<li>When we call the constructor, the compiled code will end up <strong>creating the object proper on the heap</strong>.</li>
<li>The two class running together will end up <strong>taking the base address of the newly created object</strong> and <strong>storing it in what we assign previously the p1 variable</strong>.</li>
</ul>
<h3><span id="2the-callerss-side"> 2.The callers&#x2019;s side</span></h3>
<p><img src="/2024/04/25/10-6-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%9E%84%E9%80%A0/image-1.png" alt></p>
<ul>
<li>
<p>Whenever the compiler encounters a variable declaration, it <strong>generates no code whatsover</strong>. The only thing the compiler does is it <strong>update the relevant symbol table</strong>. Because we are now compiling code that resides in a certain subroutine, we will end up <strong>updating the symbol table of the subroutine</strong>.</p>
</li>
<li>
<p><code>Point.new(2, 3)</code> is a call to some subroutine, so we handle it just like other subroutine. We push the two arguments and <code>call Point.new</code></p>
</li>
<li>
<p>The calling code assumes that when the constructor will execute, it will end up <strong>allocating some space on the RAM</strong> for the newly constructed object. It will also take the base address of this space on the RAM and <strong>return it to the caller</strong>.</p>
</li>
<li>
<p>So we <strong><code>pop</code> the topmost value of the stack into <code>p1</code></strong>, because we want <code>p1</code> to point at the base address of this object.</p>
</li>
</ul>
<h3><span id="3resulting-impact"> 3.Resulting impact</span></h3>
<p><img src="/2024/04/25/10-6-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%9E%84%E9%80%A0/image-2.png" alt></p>
<ul>
<li>Only when we call the constructors will we actually create the objects on RAM.</li>
<li>Object construction is a <strong>two-stage affair that happens both during compile time and run time</strong>.</li>
</ul>
<h3><span id="4the-big-picture-of-constructors"> 4.The big picture of constructors</span></h3>
<p><img src="/2024/04/25/10-6-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%9E%84%E9%80%A0/image-3.png" alt></p>
<p>&#x2003;&#x2003;A constructor is typically designed to do at least two things:</p>
<ol>
<li><strong>Arrange some place</strong> on RAM for the new object.</li>
<li><strong>Assign certain values</strong> to the fields of the newly constructed object.</li>
</ol>
<p>&#x2003;&#x2003;To do this, the constructor must have access to the object&#x2019;s fields:</p>
<ul>
<li>We can <strong>manipulate <code>THIS</code> segment</strong> to manipulate the object that the constructor juct created.</li>
<li>To access <code>THIS</code> segment, we first <strong>anchor it properly on the right address in the RAM</strong> using <code>pointer</code> segment.</li>
</ul>
<h3><span id="5compiling-constuctor"> 5.Compiling constuctor</span></h3>
<ol>
<li>The first thing we meet is the constructor signature. The compiler will generate no code whatsover. The only thing it will do is <strong>it will create the subroutine symbol table</strong> and **record in it two variables <code>ax</code> and <code>ay</code> which are both arguments **</li>
</ol>
<p>&#x2003;&#x2003;Then comes the question: how much space is needed?</p>
<ol start="2">
<li>The compiler can <strong>consult the class level symbol table</strong> and realize that objects of the point class requires two words only, <code>x</code> and <code>y</code>.</li>
</ol>
<p>&#x2003;&#x2003;Then how do we find such a free memory block on RAM?</p>
<ol start="3">
<li>
<p>The <em>operating system</em> supplies a function called <code>alloc</code>, if you provide <code>alloc(x)</code> with a certain argument, it will <strong>find a memory block on the RAM</strong> and <strong>return the base address of it.</strong> The memory block has two important properties:</p>
<ol>
<li>It&#x2019;s <code>x</code> words long.</li>
<li>It&#x2019;s free, no one needs it now, so the constructor can safely use it.</li>
</ol>
</li>
</ol>
<p><img src="/2024/04/25/10-6-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E6%9E%84%E9%80%A0/image-4.png" alt></p>
<ol>
<li>We <code>push 2</code>, because we <strong>need 2 words to store the arguments</strong>.</li>
<li>We want to push <code>THIS</code> into the stack, we need 1 word, so we <code>call Memory.alloc 1</code>.</li>
<li>As usual, we anchor <code>THIS</code> at the base address: <code>pop pointer 0</code>.</li>
</ol>
<blockquote>
<p>If we do <code>pop pointer 0</code>, we are going to align the virtual segment ot the object we currently constructed on the RAM. We do this because I know that with very high likelihood the next commands in the constructor will want to access the fields of the newly created object.</p>
</blockquote>
<ol start="4">
<li>Since <code>THIS</code> is anchored on the right endness, to <code>return</code>, we simply do <code>push pointer 0</code>. And when the caller of constructor do <code>pop pointer 0</code>, it can successfully get the address of the newly created object.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/22/10-5-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E5%BA%95%E5%B1%82%E7%89%B9%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/22/10-5-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E5%BA%95%E5%B1%82%E7%89%B9%E6%80%A7/" class="post-title-link" itemprop="url">10.5.&#x5BF9;&#x5BF9;&#x8C61;&#x7684;&#x5904;&#x7406;&#x2014;&#x2014;&#x5E95;&#x5C42;&#x7279;&#x6027;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-22 20:15:43" itemprop="dateCreated datePublished" datetime="2024-04-22T20:15:43+08:00">2024-04-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 15:52:40" itemprop="dateModified" datetime="2024-06-03T15:52:40+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-10-Code-Generator/" itemprop="url" rel="index"><span itemprop="name">Module 10.Code Generator</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>401</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>1 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="105105105handling-objects-low-level-aspects"> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10.5.</mn></mrow><annotation encoding="application/x-tex">10.5.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mord">.</span></span></span></span>Handling Objects: Low-level Aspects</span></h1>
<p><img src="/2024/04/22/10-5-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E5%BA%95%E5%B1%82%E7%89%B9%E6%80%A7/image.png" alt></p>
<h3><span id="1handling-objects"> 1.Handling objects</span></h3>
<p>&#x2003;&#x2003;Let&#x2019;s review how we handle <code>local</code> and <code>argument</code> first:</p>
<p><img src="/2024/04/22/10-5-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E5%BA%95%E5%B1%82%E7%89%B9%E6%80%A7/image-1.png" alt></p>
<ul>
<li>
<p>The first five words in the RAM are used as <strong>pointer that hold the current value of the stack pointer, namely the base address of the <code>local</code>, <code>argument</code>, <code>this</code>, <code>that </code></strong>.</p>
</li>
<li>
<p>The VM implementation also allocates a certain area on RAM to hold the global stack which <strong>keeps the working stack of the currentlt running VM functions</strong> and all the working stack and memory segments of the functions that wait to for the current function to terminate, namely the functions which <strong>are on the calling chain</strong>.</p>
</li>
<li>
<p>The VM implementation recalls the location of these segments of the stack by <strong>using the two pointers <code>LCL</code> and <code>ARG</code></strong>. It records the base address of this segment in the <code>LCL</code>.</p>
</li>
</ul>
<p>&#x2003;&#x2003;Then how can we use the same architecture to represent object and array data?</p>
<ol>
<li>We use a different area altogether on the RAM called <em><code>heap</code></em>.</li>
<li>On the <code>heap</code>, we recall the data of all the objects and the arrays that the current program seeks to manipulate.</li>
</ol>
<p><img src="/2024/04/22/10-5-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E5%BA%95%E5%B1%82%E7%89%B9%E6%80%A7/image-2.png" alt></p>
<p>&#x2003;&#x2003;As opposed to the <code>local</code> and <code>argument</code> segments which have only one of each to worry about, here you may have many objects on the heap. So before we access an object using <code>this</code> segment, we have to tell the system <strong>to which object are we actually referring</strong>?</p>
<ul>
<li>The implementation of <code>this</code> location is first <strong>use the pointer <code>this</code> and <code>that</code></strong>.</li>
<li>Before we use the two segments, we <strong>first have to use the <code>pointer</code> segment</strong> to <strong>tell the system where we want to align <code>this</code> and <code>that</code> on the RAM</strong>.</li>
</ul>
<blockquote>
<p>We had to provide a mechanism to anchor this and that on the particular object and array the code has to operate on and we are using this virtual segment pointer for this purpose.</p>
</blockquote>
<p>&#x2003;&#x2003;Now, suppose we want to access RAM words 8000, 8001, 8002&#x2026; We can achieve this by the following VM code:</p>
<p><img src="/2024/04/22/10-5-%E5%AF%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%84%E7%90%86-%E5%BA%95%E5%B1%82%E7%89%B9%E6%80%A7/image-3.png" alt></p>
<ul>
<li>Once we set <code>THIS</code> pointer to a particular address, <strong><code>THIS</code>can be used as if it&#x2019;s anchored exactly on the 8000th address in RAM</strong>. Given this desired mapping, we can use command related to <code>THIS</code>.</li>
<li><code>push this 0</code> will <strong>take the value which is currently located in <code>RAM 8000</code> onto the stack</strong>.</li>
<li><code>pop this 0</code> will <strong>take something off the stack and put it into <code>RAM 8000</code></strong>.</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/20/10-4-%E5%AF%B9%E6%8E%A7%E5%88%B6%E6%B5%81%E7%9A%84%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/20/10-4-%E5%AF%B9%E6%8E%A7%E5%88%B6%E6%B5%81%E7%9A%84%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">10.4.&#x5BF9;&#x63A7;&#x5236;&#x6D41;&#x7684;&#x5904;&#x7406;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-20 19:15:43" itemprop="dateCreated datePublished" datetime="2024-04-20T19:15:43+08:00">2024-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 15:44:11" itemprop="dateModified" datetime="2024-06-03T15:44:11+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-10-Code-Generator/" itemprop="url" rel="index"><span itemprop="name">Module 10.Code Generator</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>77</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>1 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="114114114handling-flow-of-control"> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>11.4.</mn></mrow><annotation encoding="application/x-tex">11.4.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">.</span><span class="mord">4</span><span class="mord">.</span></span></span></span>Handling Flow of Control</span></h1>
<p><img src="/2024/04/20/10-4-%E5%AF%B9%E6%8E%A7%E5%88%B6%E6%B5%81%E7%9A%84%E5%A4%84%E7%90%86/image.png" alt></p>
<ul>
<li>The <code>not</code> operation will <strong>turn the expression into a boolean value</strong>, thus make out code simpler and tighter.</li>
<li>The compiler generates these labels automatically.</li>
</ul>
<p><img src="/2024/04/20/10-4-%E5%AF%B9%E6%8E%A7%E5%88%B6%E6%B5%81%E7%9A%84%E5%A4%84%E7%90%86/image-1.png" alt></p>
<p>&#x2003;&#x2003;In a program, we may have multiple <code>if</code> and <code>while</code>statements, to deal we this, we only have to assure that <strong>the compiler generates unique labels</strong>.</p>
<p>&#x2003;&#x2003;Also the <code>if</code> and <code>while</code> statements may be nested. That is , <strong>the compiler employs a highly recursive compilation</strong>.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/20/10-2-%E5%AF%B9%E5%8F%98%E9%87%8F%E7%9A%84%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/20/10-2-%E5%AF%B9%E5%8F%98%E9%87%8F%E7%9A%84%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">10.2.&#x5BF9;&#x53D8;&#x91CF;&#x7684;&#x5904;&#x7406;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-20 09:15:43" itemprop="dateCreated datePublished" datetime="2024-04-20T09:15:43+08:00">2024-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 15:36:13" itemprop="dateModified" datetime="2024-06-03T15:36:13+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-10-Code-Generator/" itemprop="url" rel="index"><span itemprop="name">Module 10.Code Generator</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>756</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>3 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="112112112handling-variables"> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>11.2</mn></mrow><annotation encoding="application/x-tex">11.2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span></span></span></span>Handling Variables</span></h1>
<h3><span id="1program-compilation"> 1.Program compilation</span></h3>
<p>&#x2003;&#x2003;Remember that the VM language doesn&#x2019;t have symbolic variables, it only has <code>local</code>, <code>this</code> and so on. In order to resolve this pseudocode into final executable VM code, we have to <strong>map these symbolic variables on what is called <em>virtual memory segments</em></strong>. And to do this, we:</p>
<ul>
<li>need the <strong>variable properties</strong>.</li>
<li>also have to know <strong>the index of the variable of its kind</strong>(first, second, etc.).</li>
</ul>
<p>&#x2003;&#x2003;And the properties of variables include:</p>
<ul>
<li>
<p><em>name</em>: It&#x2019;s an identifier.</p>
</li>
<li>
<p><em>type</em>: <code>int</code>, <code>char</code>, <code>boolean</code> and <strong>all class name</strong>.</p>
</li>
<li>
<p><em>kind</em>: There are two kinds of variables, and we view them separately:</p>
<ul>
<li><em>class level</em>: <code>field</code>, <code>static</code> variables.</li>
<li><em>subroutine level</em>: <code>argument</code> and <code>local</code> variables.</li>
</ul>
</li>
<li>
<p><em>scope</em>, which is the region of the code in which it is recognized.</p>
</li>
</ul>
<h3><span id="2symbol-table"> 2.Symbol table</span></h3>
<p>&#x2003;&#x2003;We handle the property of variables using a <em>symbol table</em>:</p>
<p><img src="/2024/04/20/10-2-%E5%AF%B9%E5%8F%98%E9%87%8F%E7%9A%84%E5%A4%84%E7%90%86/image.png" alt></p>
<ul>
<li>A method is always designed to operate on the current object which is called <code>this</code>. Therefore, the symbol table of method <strong>always begins with <code>this</code> entry</strong>, which represents the properties of current object.</li>
<li><code>this</code> is always treated as <code>argument 0</code></li>
<li>The type of current object is <strong>the name of the class to which this subroutine belongs</strong>.</li>
</ul>
<p>&#x2003;&#x2003;The class level symbol table can be reset each time we begin to compile a new class, for <strong>classes are standalone compilation unity</strong>. Something similar happens when we compile subroutines.</p>
<p>&#x2003;&#x2003;The code writer is going to encounter all sorts of variable declaration commands, of which in Jack we have three: <code>local</code>, <code>field</code> and <code>static</code>.</p>
<p>&#x2003;&#x2003;Then it&#x2019;s going to elucidate all important properties of the declared variables, and <strong>add the information to the respective symbol table</strong>. It generates no code whatsoever beyond updating the symbol tables.</p>
<ul>
<li>If we are defining a <code>field</code> or a <code>static</code> variable, the code writer will add a new row to the end of the class level symbol table.</li>
<li>If we are defining <code>local</code> or <code>argument</code>, the code writer will update the symbol table of the subroutine which is currently being compiled.</li>
<li>Arguments are being defined as <strong>part of the parameter list of the method&#x2019;s signature</strong>. When the code writer goes through the parameter list, it adds the respective lines to the subroutine&#x2019;s symbol table.</li>
</ul>
<p><img src="/2024/04/20/10-2-%E5%AF%B9%E5%8F%98%E9%87%8F%E7%9A%84%E5%A4%84%E7%90%86/image-1.png" alt></p>
<p>&#x2003;&#x2003;What about using variables within the context of expressions or statements. Take <code>let dx = x - other.getX();</code> as an example:</p>
<ul>
<li>
<p>For each variable in the code, we <strong>look up this variable in the subroutine level symbol table</strong>.</p>
<ul>
<li>If we find it there, we know which property we have to use.</li>
<li>If don&#x2019;t, we revert to <strong>looking it up in the class level symbol table</strong>.</li>
<li>If don&#x2019;t either, we can conclude that the variable is undefined and throw an error message.</li>
</ul>
</li>
</ul>
<p>&#x2003;&#x2003;How can the statements be translated into VM code? Take <code>let y = y +dy</code> for example:</p>
<ol>
<li>In the process of generating code, the code generator will look up the respective table.</li>
<li>It finds out that <strong><code>y</code> stands for the second <code>field</code> of the current object</strong>, so it will be translated into <code>this 1</code></li>
<li><code>dy</code> stands for the second <code>local</code> variable, so it will be translated into <code>local 1</code></li>
</ol>
<p><img src="/2024/04/20/10-2-%E5%AF%B9%E5%8F%98%E9%87%8F%E7%9A%84%E5%A4%84%E7%90%86/image-2.png" alt></p>
<p><img src="/2024/04/20/10-2-%E5%AF%B9%E5%8F%98%E9%87%8F%E7%9A%84%E5%A4%84%E7%90%86/image-3.png" alt></p>
<h3><span id="3handling-variables-in-general"> 3.Handling variables in general</span></h3>
<p>&#x2003;&#x2003;High level of programming languages vary in terms of:</p>
<ul>
<li>variable types</li>
<li>variable kinds</li>
<li>nested scoping rules</li>
</ul>
<p>&#x2003;&#x2003;And the symbol table generation and usage we discussed right now can be easily entended to handle any number of possible variables types and kinds.</p>
<p>&#x2003;&#x2003;Some languages, like Java, feature <em>unlimited scoping</em>. this means that whenever you define a block of code with a pair of curly brackets, you can define variables within this code which are recognized only within that block. <code>x</code> in this scope doesn&#x2019;t mean the same as <code>x</code> in that block.</p>
<p>&#x2003;&#x2003;To represent the information in our symbol table mechanism, we use <strong>a linked list of symbol tables</strong>:</p>
<ul>
<li>When start compiling the class, we first create an linked list.</li>
<li>The first symbol table we add to the list is the class level symbol table.</li>
<li>When we start compiling a method, we create the method symbol table like before.</li>
<li>Whenever we have another scoping region, we <strong>add another symbol table to the linked list</strong>.</li>
</ul>
<p><img src="/2024/04/20/10-2-%E5%AF%B9%E5%8F%98%E9%87%8F%E7%9A%84%E5%A4%84%E7%90%86/image-4.png" alt></p>
<p>&#x2003;&#x2003;When you encounter some variable <code>x</code> in the code we:</p>
<ol>
<li>Look up <code>x</code> in the current scope, which is also the first table.</li>
<li>If fail, we move to the next symbol table.</li>
<li>We simply go on downstream until we get to the class level symbol table.</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang>
    <link itemprop="mainEntityOfPage" href="https://fyerfyer.github.io.com/2024/04/20/10-3-%E5%AF%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="fyerfyer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fyerfyer">
      <meta itemprop="description" content="fyerfyer&apos;s blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | fyerfyer">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/04/20/10-3-%E5%AF%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">10.3.&#x5BF9;&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x5904;&#x7406;</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">&#x53D1;&#x8868;&#x4E8E;</span>

      <time title="&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#xFF1A;2024-04-20 09:15:43" itemprop="dateCreated datePublished" datetime="2024-04-20T09:15:43+08:00">2024-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">&#x66F4;&#x65B0;&#x4E8E;</span>
      <time title="&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;2024-06-03 15:39:49" itemprop="dateModified" datetime="2024-06-03T15:39:49+08:00">2024-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">&#x5206;&#x7C7B;&#x4E8E;</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/" itemprop="url" rel="index"><span itemprop="name">The Elements of Computer System</span></a>
        </span>
          &#xFF0C;
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/The-Elements-of-Computer-System/Module-10-Code-Generator/" itemprop="url" rel="index"><span itemprop="name">Module 10.Code Generator</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="&#x672C;&#x6587;&#x5B57;&#x6570;">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">&#x672C;&#x6587;&#x5B57;&#x6570;&#xFF1A;</span>
      <span>397</span>
    </span>
    <span class="post-meta-item" title="&#x9605;&#x8BFB;&#x65F6;&#x957F;">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
      <span>1 &#x5206;&#x949F;</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1><span id="113113113handling-expression"> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>11.3.</mn></mrow><annotation encoding="application/x-tex">11.3.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mord">.</span><span class="mord">3</span><span class="mord">.</span></span></span></span>Handling Expression</span></h1>
<h3><span id="1expressions-definition-review"> 1.Expressions definition review</span></h3>
<p><img src="/2024/04/20/10-3-%E5%AF%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86/image-5.png" alt></p>
<h3><span id="2parse-tree"> 2.Parse tree</span></h3>
<p><img src="/2024/04/20/10-3-%E5%AF%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86/image-6.png" alt></p>
<ul>
<li><em>infix</em>: that&#x2019;s sort of ingrained into our brains in elementary school.</li>
<li><em>prefix</em>: that&#x2019;s what we do when we define functions: we put the function name and then a list of operands or parameters or arguments.</li>
<li><em>postfix</em>: that&#x2019;s closely related to the stack machine. Say we want to do an <code>add</code> operation, we <code>push x</code>, <code>push y</code> and finally <code>pop</code>, this is exactly postfix.</li>
</ul>
<h3><span id="3generating-code-for-expressions"> 3.Generating code for expressions</span></h3>
<p>&#x2003;&#x2003;In high level language like Java, we declare expressions in infix, and the target language, so our compiler has to translate from infix to postfix. Here are two ways to do this:</p>
<p><img src="/2024/04/20/10-3-%E5%AF%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86/image-7.png" alt></p>
<ol>
<li>We generate a parse tree through the infix expression.</li>
<li>The parser takes the source code and produces XML code from it.</li>
<li>We go through every node in the parse tree in a certain order.</li>
</ol>
<p>&#x2003;&#x2003;To convert the parse tree into the VM code, we use the <em>deep-first tree traversal algorithm</em>:</p>
<ul>
<li>We go all the way down, and when we hit a terminal leaf, we process it.</li>
</ul>
<p>&#x2003;&#x2003;However, the parse tree we have may be gigantic, so it may be better not to have the side effect. We will use the following code generation algorithm instead:</p>
<p><img src="/2024/04/20/10-3-%E5%AF%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%A4%84%E7%90%86/image-8.png" alt></p>
<ul>
<li>Whatever is the mapping of <code>x</code> is dictated by the symbol table which is always in the background of the co-generation algorithms.</li>
</ul>
<p>&#x2003;&#x2003;The nice thing about this algorithm is that not only does it <strong>capture the semantics of the input expression</strong>, it also <strong>computes the value of this expression</strong>. That is, in the runtime the value of the expression is going to be placed on the stack.</p>
<h3><span id="4from-parsing-to-code-generation"> 4.From parsing to code generation</span></h3>
<p>&#x2003;&#x2003;In the previous project, we develop a Jack Analyzer that generate static XML code, but in this part, the XML is completely irrelevant now. Instead, we generate actual executable VM code. And there are some general guidelines on what has to be done:</p>
<ul>
<li>We have <strong>operator priority</strong> in some operation, such as mathematics operations (however, Jack doesn&#x2019;t have this). Since the compiler will ignore it, we ourselves must take this into consideration.</li>
<li>Once we have parenthesis in Jack, we have to take operator priority into consideration. We have to make the code write algorithm work in the proper order as dictated by the parenthesis.</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="&#x4E0A;&#x4E00;&#x9875;" aria-label="&#x4E0A;&#x4E00;&#x9875;" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&#x2026;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&#x2026;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" title="&#x4E0B;&#x4E00;&#x9875;" aria-label="&#x4E0B;&#x4E00;&#x9875;" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">



  <div class="copyright">
    &#xA9; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">fyerfyer</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>&#x7AD9;&#x70B9;&#x603B;&#x5B57;&#x6570;&#xFF1A;</span>
    <span title="&#x7AD9;&#x70B9;&#x603B;&#x5B57;&#x6570;">96k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>&#x7AD9;&#x70B9;&#x9605;&#x8BFB;&#x65F6;&#x957F; &#x2248;</span>
    <span title="&#x7AD9;&#x70B9;&#x9605;&#x8BFB;&#x65F6;&#x957F;">5:49</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="&#x603B;&#x8BBF;&#x5BA2;&#x91CF;">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="&#x603B;&#x8BBF;&#x95EE;&#x91CF;">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">&#x7531; <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> &#x5F3A;&#x529B;&#x9A71;&#x52A8;
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
